<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>EIP-3670: 智慧合約的程式碼檢查 | 一本關於 Ethereum 與 Solidity 智能合約的書</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="在 2022 年，我們該如何學習智能合約開發">
    
    <link rel="preload" href="/assets/css/0.styles.9f477098.css" as="style"><link rel="preload" href="/assets/js/app.b4a0f8ef.js" as="script"><link rel="preload" href="/assets/js/2.ce7b5ffa.js" as="script"><link rel="preload" href="/assets/js/1.843ff0e7.js" as="script"><link rel="preload" href="/assets/js/57.17e6376e.js" as="script"><link rel="prefetch" href="/assets/js/10.c12fac62.js"><link rel="prefetch" href="/assets/js/11.c2affc04.js"><link rel="prefetch" href="/assets/js/12.f054eba6.js"><link rel="prefetch" href="/assets/js/13.e4d40fa1.js"><link rel="prefetch" href="/assets/js/14.ed0a28d5.js"><link rel="prefetch" href="/assets/js/15.d25bd3fe.js"><link rel="prefetch" href="/assets/js/16.97c2c4a8.js"><link rel="prefetch" href="/assets/js/17.849d402a.js"><link rel="prefetch" href="/assets/js/18.cdc68d17.js"><link rel="prefetch" href="/assets/js/19.e30826d9.js"><link rel="prefetch" href="/assets/js/20.8effbcd5.js"><link rel="prefetch" href="/assets/js/21.9653cdd5.js"><link rel="prefetch" href="/assets/js/22.cb4ae59c.js"><link rel="prefetch" href="/assets/js/23.b6fc1300.js"><link rel="prefetch" href="/assets/js/24.778ffaf6.js"><link rel="prefetch" href="/assets/js/25.ff81639a.js"><link rel="prefetch" href="/assets/js/26.af99b220.js"><link rel="prefetch" href="/assets/js/27.74198ac3.js"><link rel="prefetch" href="/assets/js/28.a47a9604.js"><link rel="prefetch" href="/assets/js/29.4f16422d.js"><link rel="prefetch" href="/assets/js/3.16c4453f.js"><link rel="prefetch" href="/assets/js/30.f298419f.js"><link rel="prefetch" href="/assets/js/31.1a21d7a4.js"><link rel="prefetch" href="/assets/js/32.14fd2d9a.js"><link rel="prefetch" href="/assets/js/33.416bd998.js"><link rel="prefetch" href="/assets/js/34.82b44d0c.js"><link rel="prefetch" href="/assets/js/35.27e3d54a.js"><link rel="prefetch" href="/assets/js/36.c3b1843c.js"><link rel="prefetch" href="/assets/js/37.d6736751.js"><link rel="prefetch" href="/assets/js/38.ef4141df.js"><link rel="prefetch" href="/assets/js/39.15fc33ad.js"><link rel="prefetch" href="/assets/js/4.7b5274ce.js"><link rel="prefetch" href="/assets/js/40.0c8f408e.js"><link rel="prefetch" href="/assets/js/41.95c43a4c.js"><link rel="prefetch" href="/assets/js/42.37e3dbc1.js"><link rel="prefetch" href="/assets/js/43.726b47f6.js"><link rel="prefetch" href="/assets/js/44.0c623027.js"><link rel="prefetch" href="/assets/js/45.a9d47927.js"><link rel="prefetch" href="/assets/js/46.a01f013b.js"><link rel="prefetch" href="/assets/js/47.f909334f.js"><link rel="prefetch" href="/assets/js/48.f3ce3acc.js"><link rel="prefetch" href="/assets/js/49.bf17f86c.js"><link rel="prefetch" href="/assets/js/5.a90aa973.js"><link rel="prefetch" href="/assets/js/50.76543ed3.js"><link rel="prefetch" href="/assets/js/51.a77781e8.js"><link rel="prefetch" href="/assets/js/52.522cda49.js"><link rel="prefetch" href="/assets/js/53.4e88f52c.js"><link rel="prefetch" href="/assets/js/54.565c39aa.js"><link rel="prefetch" href="/assets/js/55.d04ba7d8.js"><link rel="prefetch" href="/assets/js/56.7ce37e58.js"><link rel="prefetch" href="/assets/js/58.62087995.js"><link rel="prefetch" href="/assets/js/59.c526d55f.js"><link rel="prefetch" href="/assets/js/6.acf7bb6e.js"><link rel="prefetch" href="/assets/js/60.ab86d4cc.js"><link rel="prefetch" href="/assets/js/61.dc1027c2.js"><link rel="prefetch" href="/assets/js/62.d1faa0e3.js"><link rel="prefetch" href="/assets/js/63.27478a7c.js"><link rel="prefetch" href="/assets/js/64.774fdd9e.js"><link rel="prefetch" href="/assets/js/65.bdeefe51.js"><link rel="prefetch" href="/assets/js/66.569b3bd4.js"><link rel="prefetch" href="/assets/js/67.faa6f699.js"><link rel="prefetch" href="/assets/js/7.dfcce160.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.d9dffa33.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9f477098.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">一本關於 Ethereum 與 Solidity 智能合約的書</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首頁
</a></div><div class="nav-item"><a href="/ethereum-101/" class="nav-link">
  那些關於 Ethereum 的事
</a></div><div class="nav-item"><a href="https://youtube.com/playlist?list=PLHmOMPRfmOxQYDnXAc1hKY6ra4WDU8ZlM" target="_blank" rel="noopener noreferrer" class="nav-link external">
  在 2022 年，我們該如何寫智能合約
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://www.youtube.com/playlist?list=PLHmOMPRfmOxTiqyaSu1EXs8ioESZtOSHN" target="_blank" rel="noopener noreferrer" class="nav-link external">
  淺入淺出 EVM Object Format
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/hydai/solidity.tw" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首頁
</a></div><div class="nav-item"><a href="/ethereum-101/" class="nav-link">
  那些關於 Ethereum 的事
</a></div><div class="nav-item"><a href="https://youtube.com/playlist?list=PLHmOMPRfmOxQYDnXAc1hKY6ra4WDU8ZlM" target="_blank" rel="noopener noreferrer" class="nav-link external">
  在 2022 年，我們該如何寫智能合約
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://www.youtube.com/playlist?list=PLHmOMPRfmOxTiqyaSu1EXs8ioESZtOSHN" target="_blank" rel="noopener noreferrer" class="nav-link external">
  淺入淺出 EVM Object Format
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/hydai/solidity.tw" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Head First Eof</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/head-first-eof/" aria-current="page" class="sidebar-link">深入淺出 EOFv1</a></li><li><a href="/head-first-eof/10-EIP-3541.html" class="sidebar-link">EIP-3541 禁止以 0xEF 開頭的新智慧合約</a></li><li><a href="/head-first-eof/11-EIP-3540.html" class="sidebar-link">EIP-3540 電腦程式的新衣服 - EVM 物件格式 (EOF)</a></li><li><a href="/head-first-eof/12-EIP-3670.html" aria-current="page" class="active sidebar-link">EIP-3670: 智慧合約的程式碼檢查</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/head-first-eof/12-EIP-3670.html#注意事項" class="sidebar-link">注意事項</a></li><li class="sidebar-sub-header"><a href="/head-first-eof/12-EIP-3670.html#什麼是這個提案" class="sidebar-link">什麼是這個提案？</a></li><li class="sidebar-sub-header"><a href="/head-first-eof/12-EIP-3670.html#為什麼需要這個提案" class="sidebar-link">為什麼需要這個提案？</a></li><li class="sidebar-sub-header"><a href="/head-first-eof/12-EIP-3670.html#這個提案會怎麼運作" class="sidebar-link">這個提案會怎麼運作？</a></li><li class="sidebar-sub-header"><a href="/head-first-eof/12-EIP-3670.html#這個提案有什麼好處" class="sidebar-link">這個提案有什麼好處？</a></li><li class="sidebar-sub-header"><a href="/head-first-eof/12-EIP-3670.html#會影響到舊的程式嗎" class="sidebar-link">會影響到舊的程式嗎？</a></li><li class="sidebar-sub-header"><a href="/head-first-eof/12-EIP-3670.html#舉個例子" class="sidebar-link">舉個例子</a></li><li class="sidebar-sub-header"><a href="/head-first-eof/12-EIP-3670.html#實際的程式碼範例解釋" class="sidebar-link">實際的程式碼範例解釋</a></li><li class="sidebar-sub-header"><a href="/head-first-eof/12-EIP-3670.html#有效和無效的程式碼例子" class="sidebar-link">有效和無效的程式碼例子</a></li></ul></li><li><a href="/head-first-eof/13-EIP-4200.html" class="sidebar-link">EIP-4200：EOF - 靜態相對跳躍</a></li><li><a href="/head-first-eof/14-EIP-7480.html" class="sidebar-link">EIP-7480: EOF - 資料區段存取指令</a></li><li><a href="/head-first-eof/15-EIP-663.html" class="sidebar-link">EIP-663：SWAPN、DUPN 和 EXCHANGE 指令</a></li><li><a href="/head-first-eof/16-EIP-7069.html" class="sidebar-link">EIP-7069 改良版呼叫指令</a></li><li><a href="/head-first-eof/17-EIP-4750.html" class="sidebar-link">EIP-4750 EOF 函式功能</a></li><li><a href="/head-first-eof/18-EIP-6206.html" class="sidebar-link">EIP-6206 - JUMPF 與非回傳函式</a></li><li><a href="/head-first-eof/19-EIP-7620.html" class="sidebar-link">EIP-7620：EOF 合約部署新方式</a></li><li><a href="/head-first-eof/20-EIP-7698.html" class="sidebar-link">EIP-7698: EOF - 部署交易</a></li><li><a href="/head-first-eof/21-EIP-5450.html" class="sidebar-link">EIP-5450: EOF - 堆疊驗證</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="eip-3670-智慧合約的程式碼檢查"><a href="#eip-3670-智慧合約的程式碼檢查" class="header-anchor">#</a> EIP-3670: 智慧合約的程式碼檢查</h1> <h2 id="注意事項"><a href="#注意事項" class="header-anchor">#</a> 注意事項</h2> <p>本文並沒有經過作者外的其他審查者審核，因此若內容有誤，請到 issue 區提出問題，我會儘速修改，謝謝。</p> <h2 id="什麼是這個提案"><a href="#什麼是這個提案" class="header-anchor">#</a> 什麼是這個提案？</h2> <p>這個提案是要在以太坊區塊鏈上，當有人想要建立新的智慧合約時，先檢查程式碼是否正確。就像老師在你交作業前先檢查你的作業有沒有寫完整一樣！</p> <h2 id="為什麼需要這個提案"><a href="#為什麼需要這個提案" class="header-anchor">#</a> 為什麼需要這個提案？</h2> <p>想像一下，如果你在寫國語作文時，有些字沒寫完整或是用了不存在的字，別人讀的時候就會很困惑。現在的智慧合約就有這個問題 - 它們可能包含「不完整的指令」或「不存在的指令」，讓電腦執行時很困惑。</p> <p>這個提案要讓所有人同意：只有「寫得完整」且「只用已知操作碼」的位元組碼才能成為智慧合約。這樣大家就能更容易理解程式碼在做什麼，電腦也能更有效率地執行它們。</p> <h2 id="這個提案會怎麼運作"><a href="#這個提案會怎麼運作" class="header-anchor">#</a> 這個提案會怎麼運作？</h2> <p>當有人想要建立新的智慧合約時，系統會檢查程式碼是否符合以下規則：</p> <ol><li><p>不能使用已經「被淘汰」的操作碼，就像你不能在現代作文中使用已經廢除的繁體字一樣。</p></li> <li><p>程式碼需要「完整」：</p> <ul><li>每個操作碼必須是電腦認識的（就像你寫的每個字都必須是真實存在的字）</li> <li>程式碼不能寫到一半就斷掉（就像你的句子不能說到一半就...)</li></ul></li></ol> <h2 id="這個提案有什麼好處"><a href="#這個提案有什麼好處" class="header-anchor">#</a> 這個提案有什麼好處？</h2> <ol><li>程式設計師可以更確定他們的程式會被正確執行</li> <li>系統可以更有效率地運作</li> <li>未來如果要增加新的操作碼，不會跟已經存在的程式衝突</li></ol> <h2 id="會影響到舊的程式嗎"><a href="#會影響到舊的程式嗎" class="header-anchor">#</a> 會影響到舊的程式嗎？</h2> <p>不會喔！這個提案只會影響到新的、使用特殊格式（叫做EOF，以太坊物件格式）的智慧合約。舊的程式完全不受影響，可以繼續正常運作。</p> <h2 id="舉個例子"><a href="#舉個例子" class="header-anchor">#</a> 舉個例子</h2> <p>想像你在玩一個積木遊戲：</p> <ul><li><strong>合格的程式</strong>：所有積木都是玩具組裡有的積木，而且每個積木都放好了。</li> <li><strong>不合格的程式</strong>：有些積木是你自己畫的（系統不認識的操作碼），或是有些積木只放了一半（不完整的指令）。</li></ul> <p>這個提案就是要確保所有新建立的智慧合約都是「合格的程式」。</p> <h2 id="實際的程式碼範例解釋"><a href="#實際的程式碼範例解釋" class="header-anchor">#</a> 實際的程式碼範例解釋</h2> <p>以下是一段檢查程式碼是否符合規則的程式碼，我會用簡單的方式解釋：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 以下是上海版本以太坊可以使用的操作碼</span>
<span class="token comment"># 備註：range(s, e) 不包含 e，所以要 +1</span>
shanghai_opcodes <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token operator">*</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x0b</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 這些數字代表不同的操作碼</span>
    <span class="token operator">*</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token number">0x1d</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token number">0x20</span><span class="token punctuation">,</span>
    <span class="token operator">*</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">0x3f</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token operator">*</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0x48</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token operator">*</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0x50</span><span class="token punctuation">,</span> <span class="token number">0x5b</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token number">0x5f</span><span class="token punctuation">,</span>
    <span class="token operator">*</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token number">0x6f</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token operator">*</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0x70</span><span class="token punctuation">,</span> <span class="token number">0x7f</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token operator">*</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x8f</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token operator">*</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0x90</span><span class="token punctuation">,</span> <span class="token number">0x9f</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token operator">*</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0xa0</span><span class="token punctuation">,</span> <span class="token number">0xa4</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment"># 備註：0xfe 是被認可的操作碼</span>
    <span class="token number">0xf0</span><span class="token punctuation">,</span> <span class="token number">0xf1</span><span class="token punctuation">,</span> <span class="token number">0xf2</span><span class="token punctuation">,</span> <span class="token number">0xf3</span><span class="token punctuation">,</span> <span class="token number">0xf4</span><span class="token punctuation">,</span> <span class="token number">0xf5</span><span class="token punctuation">,</span> <span class="token number">0xfa</span><span class="token punctuation">,</span> <span class="token number">0xfd</span><span class="token punctuation">,</span> <span class="token number">0xfe</span><span class="token punctuation">,</span> <span class="token number">0xff</span>
<span class="token punctuation">]</span>

<span class="token comment"># 剔除在這裡和 EIP-3540 中被淘汰和拒絕的操作碼</span>
rejected_in_eof <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token number">0x38</span><span class="token punctuation">,</span> <span class="token number">0x39</span><span class="token punctuation">,</span> <span class="token number">0x3b</span><span class="token punctuation">,</span> <span class="token number">0x3c</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">,</span> <span class="token number">0x5a</span><span class="token punctuation">,</span> <span class="token number">0xf1</span><span class="token punctuation">,</span> <span class="token number">0xf2</span><span class="token punctuation">,</span> <span class="token number">0xf4</span><span class="token punctuation">,</span> <span class="token number">0xfa</span><span class="token punctuation">,</span> <span class="token number">0xff</span>
<span class="token punctuation">]</span>
valid_opcodes <span class="token operator">=</span> <span class="token punctuation">[</span>op <span class="token keyword">for</span> op <span class="token keyword">in</span> shanghai_opcodes <span class="token keyword">not</span> <span class="token keyword">in</span> rejected_in_eof<span class="token punctuation">]</span>

<span class="token comment"># 這裡定義了每個操作碼需要多少額外資料</span>
immediate_sizes <span class="token operator">=</span> <span class="token number">256</span> <span class="token operator">*</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
immediate_sizes<span class="token punctuation">[</span><span class="token number">0x60</span><span class="token punctuation">:</span><span class="token number">0x7f</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># PUSH1..PUSH32 需要 1-32 個額外資料</span>


<span class="token comment"># 如果程式碼無效，這個函式會發出錯誤訊息</span>
<span class="token keyword">def</span> <span class="token function">validate_instructions</span><span class="token punctuation">(</span>code<span class="token punctuation">:</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 注意 EOF1 已經確保這一點</span>
    <span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span>  <span class="token comment"># 程式碼長度必須大於 0</span>

    pos <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">while</span> pos <span class="token operator">&lt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 確保操作碼是有效的</span>
        opcode <span class="token operator">=</span> code<span class="token punctuation">[</span>pos<span class="token punctuation">]</span>
        <span class="token keyword">if</span> opcode <span class="token keyword">not</span> <span class="token keyword">in</span> valid_opcodes<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValidationException<span class="token punctuation">(</span><span class="token string">&quot;未定義的操作碼&quot;</span><span class="token punctuation">)</span>  <span class="token comment"># 如果使用了不存在的操作碼，就報錯</span>

        <span class="token comment"># 跳過此操作碼的額外資料</span>
        pos <span class="token operator">+=</span> <span class="token number">1</span> <span class="token operator">+</span> immediate_sizes<span class="token punctuation">[</span>opcode<span class="token punctuation">]</span>

    <span class="token comment"># 確保最後一個操作碼的額外資料不會超出程式碼結尾</span>
    <span class="token keyword">if</span> pos <span class="token operator">!=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> ValidationException<span class="token punctuation">(</span><span class="token string">&quot;不完整的操作碼&quot;</span><span class="token punctuation">)</span>  <span class="token comment"># 如果操作碼被截斷，就回傳錯誤</span>
</code></pre></div><h3 id="這段程式碼在做什麼"><a href="#這段程式碼在做什麼" class="header-anchor">#</a> 這段程式碼在做什麼？</h3> <p>想像你在校對一篇作文：</p> <ol><li>首先，你有一份「合法字詞表」(<code>valid_opcodes</code>)</li> <li>你從頭到尾一個字一個字地檢查：
<ul><li>如果發現一個不在「合法字詞表」上的字，你就說「這個字不存在！」</li> <li>有些字（像 PUSH 操作碼）需要後面跟著額外的資料，就像有些中文字需要部首和筆畫</li></ul></li> <li>最後，你還要確保所有的字都完整了，沒有寫到一半就結束</li></ol> <p>這段程式碼就是在做這樣的檢查，確保智慧合約的位元組碼完全符合規則。</p> <h2 id="有效和無效的程式碼例子"><a href="#有效和無效的程式碼例子" class="header-anchor">#</a> 有效和無效的程式碼例子</h2> <h3 id="有效的程式碼"><a href="#有效的程式碼" class="header-anchor">#</a> 有效的程式碼</h3> <ul><li>包含 <code>INVALID</code> (0xfe) 操作碼的 EOF 程式碼（雖然叫「無效」，但它其實是一個有效的操作碼）</li> <li>資料區段包含未定義操作碼的 EOF 程式碼（資料區段不執行，所以裡面放什麼都可以）</li></ul> <h3 id="無效的程式碼"><a href="#無效的程式碼" class="header-anchor">#</a> 無效的程式碼</h3> <ul><li>包含未定義操作碼的 EOF 程式碼（就像用了不存在的字）</li> <li>結尾是不完整 <code>PUSH</code> 操作碼的 EOF 程式碼（就像寫了一個需要部首的字，但沒把部首寫完）</li></ul> <p>這樣設計可以確保所有新的 EOF 格式智慧合約都是「正確無誤」的，讓以太坊區塊鏈運作更加穩定和安全！</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/hydai/solidity.tw/edit/master/head-first-eof/12-EIP-3670.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2025/5/21 下午3:18:25</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/head-first-eof/11-EIP-3540.html" class="prev">
        EIP-3540 電腦程式的新衣服 - EVM 物件格式 (EOF)
      </a></span> <span class="next"><a href="/head-first-eof/13-EIP-4200.html">
        EIP-4200：EOF - 靜態相對跳躍
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.b4a0f8ef.js" defer></script><script src="/assets/js/2.ce7b5ffa.js" defer></script><script src="/assets/js/1.843ff0e7.js" defer></script><script src="/assets/js/57.17e6376e.js" defer></script>
  </body>
</html>
