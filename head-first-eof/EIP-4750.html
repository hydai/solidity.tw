<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>EIP-4750 EOF 函式功能 | 一本關於 Ethereum 與 Solidity 智能合約的書</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="在 2022 年，我們該如何學習智能合約開發">
    
    <link rel="preload" href="/assets/css/0.styles.9f477098.css" as="style"><link rel="preload" href="/assets/js/app.03130786.js" as="script"><link rel="preload" href="/assets/js/2.ce7b5ffa.js" as="script"><link rel="preload" href="/assets/js/1.843ff0e7.js" as="script"><link rel="preload" href="/assets/js/59.c9dd68a1.js" as="script"><link rel="prefetch" href="/assets/js/10.c12fac62.js"><link rel="prefetch" href="/assets/js/11.c2affc04.js"><link rel="prefetch" href="/assets/js/12.f054eba6.js"><link rel="prefetch" href="/assets/js/13.e4d40fa1.js"><link rel="prefetch" href="/assets/js/14.ed0a28d5.js"><link rel="prefetch" href="/assets/js/15.d25bd3fe.js"><link rel="prefetch" href="/assets/js/16.97c2c4a8.js"><link rel="prefetch" href="/assets/js/17.849d402a.js"><link rel="prefetch" href="/assets/js/18.cdc68d17.js"><link rel="prefetch" href="/assets/js/19.e30826d9.js"><link rel="prefetch" href="/assets/js/20.8effbcd5.js"><link rel="prefetch" href="/assets/js/21.9653cdd5.js"><link rel="prefetch" href="/assets/js/22.b7240f47.js"><link rel="prefetch" href="/assets/js/23.24125751.js"><link rel="prefetch" href="/assets/js/24.778ffaf6.js"><link rel="prefetch" href="/assets/js/25.1ecda9e0.js"><link rel="prefetch" href="/assets/js/26.e699b744.js"><link rel="prefetch" href="/assets/js/27.74198ac3.js"><link rel="prefetch" href="/assets/js/28.ec93b5b4.js"><link rel="prefetch" href="/assets/js/29.ceeccee0.js"><link rel="prefetch" href="/assets/js/3.16c4453f.js"><link rel="prefetch" href="/assets/js/30.8adee311.js"><link rel="prefetch" href="/assets/js/31.ceebd025.js"><link rel="prefetch" href="/assets/js/32.14fd2d9a.js"><link rel="prefetch" href="/assets/js/33.33a6c23b.js"><link rel="prefetch" href="/assets/js/34.2ccf4e58.js"><link rel="prefetch" href="/assets/js/35.ef83bbea.js"><link rel="prefetch" href="/assets/js/36.7ad1a99a.js"><link rel="prefetch" href="/assets/js/37.d6736751.js"><link rel="prefetch" href="/assets/js/38.9ca9000c.js"><link rel="prefetch" href="/assets/js/39.38a0b840.js"><link rel="prefetch" href="/assets/js/4.7b5274ce.js"><link rel="prefetch" href="/assets/js/40.fe435d35.js"><link rel="prefetch" href="/assets/js/41.1f2152ba.js"><link rel="prefetch" href="/assets/js/42.44d60617.js"><link rel="prefetch" href="/assets/js/43.f1b1ce3c.js"><link rel="prefetch" href="/assets/js/44.f73ca724.js"><link rel="prefetch" href="/assets/js/45.d9dca9b1.js"><link rel="prefetch" href="/assets/js/46.ec7f0f6c.js"><link rel="prefetch" href="/assets/js/47.d878efb0.js"><link rel="prefetch" href="/assets/js/48.f3ce3acc.js"><link rel="prefetch" href="/assets/js/49.661853c3.js"><link rel="prefetch" href="/assets/js/5.a90aa973.js"><link rel="prefetch" href="/assets/js/50.6e80d28e.js"><link rel="prefetch" href="/assets/js/51.f60bbd2a.js"><link rel="prefetch" href="/assets/js/52.522cda49.js"><link rel="prefetch" href="/assets/js/53.5adc043f.js"><link rel="prefetch" href="/assets/js/54.b525daad.js"><link rel="prefetch" href="/assets/js/55.21b3d617.js"><link rel="prefetch" href="/assets/js/56.c7eb1c6a.js"><link rel="prefetch" href="/assets/js/57.41fdcd65.js"><link rel="prefetch" href="/assets/js/58.c55b3710.js"><link rel="prefetch" href="/assets/js/6.acf7bb6e.js"><link rel="prefetch" href="/assets/js/60.81f5cc2d.js"><link rel="prefetch" href="/assets/js/61.43d2db04.js"><link rel="prefetch" href="/assets/js/62.e95306e3.js"><link rel="prefetch" href="/assets/js/63.961a053b.js"><link rel="prefetch" href="/assets/js/64.38dcb943.js"><link rel="prefetch" href="/assets/js/65.2886d427.js"><link rel="prefetch" href="/assets/js/66.e48e3971.js"><link rel="prefetch" href="/assets/js/67.c4c643de.js"><link rel="prefetch" href="/assets/js/7.dfcce160.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.d9dffa33.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9f477098.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">一本關於 Ethereum 與 Solidity 智能合約的書</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首頁
</a></div><div class="nav-item"><a href="/ethereum-101/" class="nav-link">
  那些關於 Ethereum 的事
</a></div><div class="nav-item"><a href="https://youtube.com/playlist?list=PLHmOMPRfmOxQYDnXAc1hKY6ra4WDU8ZlM" target="_blank" rel="noopener noreferrer" class="nav-link external">
  在 2022 年，我們該如何寫智能合約
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://www.youtube.com/playlist?list=PLHmOMPRfmOxTiqyaSu1EXs8ioESZtOSHN" target="_blank" rel="noopener noreferrer" class="nav-link external">
  淺入淺出 EVM Object Format
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/hydai/solidity.tw" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首頁
</a></div><div class="nav-item"><a href="/ethereum-101/" class="nav-link">
  那些關於 Ethereum 的事
</a></div><div class="nav-item"><a href="https://youtube.com/playlist?list=PLHmOMPRfmOxQYDnXAc1hKY6ra4WDU8ZlM" target="_blank" rel="noopener noreferrer" class="nav-link external">
  在 2022 年，我們該如何寫智能合約
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://www.youtube.com/playlist?list=PLHmOMPRfmOxTiqyaSu1EXs8ioESZtOSHN" target="_blank" rel="noopener noreferrer" class="nav-link external">
  淺入淺出 EVM Object Format
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/hydai/solidity.tw" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Head First Eof</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/head-first-eof/" aria-current="page" class="sidebar-link">深入淺出 EOFv1</a></li><li><a href="/head-first-eof/EIP-3540.html" class="sidebar-link">EIP-3540 電腦程式的新衣服 - EVM 物件格式 (EOF)</a></li><li><a href="/head-first-eof/EIP-3541.html" class="sidebar-link">EIP-3541 禁止以 0xEF 開頭的新智慧合約</a></li><li><a href="/head-first-eof/EIP-3670.html" class="sidebar-link">智慧合約的程式碼檢查</a></li><li><a href="/head-first-eof/EIP-4200.html" class="sidebar-link">EIP-4200：EOF - 靜態相對跳躍</a></li><li><a href="/head-first-eof/EIP-4750.html" aria-current="page" class="active sidebar-link">EIP-4750 EOF 函式功能</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/head-first-eof/EIP-4750.html#注意事項" class="sidebar-link">注意事項</a></li><li class="sidebar-sub-header"><a href="/head-first-eof/EIP-4750.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/head-first-eof/EIP-4750.html#這個改進想要解決什麼問題" class="sidebar-link">這個改進想要解決什麼問題？</a></li><li class="sidebar-sub-header"><a href="/head-first-eof/EIP-4750.html#新的解決方案" class="sidebar-link">新的解決方案</a></li><li class="sidebar-sub-header"><a href="/head-first-eof/EIP-4750.html#如何運作" class="sidebar-link">如何運作？</a></li><li class="sidebar-sub-header"><a href="/head-first-eof/EIP-4750.html#執行過程" class="sidebar-link">執行過程</a></li><li class="sidebar-sub-header"><a href="/head-first-eof/EIP-4750.html#為什麼這樣設計" class="sidebar-link">為什麼這樣設計？</a></li><li class="sidebar-sub-header"><a href="/head-first-eof/EIP-4750.html#相容性" class="sidebar-link">相容性</a></li><li class="sidebar-sub-header"><a href="/head-first-eof/EIP-4750.html#花費成本" class="sidebar-link">花費成本</a></li><li class="sidebar-sub-header"><a href="/head-first-eof/EIP-4750.html#總結" class="sidebar-link">總結</a></li></ul></li><li><a href="/head-first-eof/EIP-5450.html" class="sidebar-link">EOF - 堆疊驗證</a></li><li><a href="/head-first-eof/EIP-6206.html" class="sidebar-link">EIP-6206 - JUMPF 與非回傳函式</a></li><li><a href="/head-first-eof/EIP-663.html" class="sidebar-link">EIP-663：SWAPN、DUPN 和 EXCHANGE 指令</a></li><li><a href="/head-first-eof/EIP-7069.html" class="sidebar-link">EIP-7069 改良版呼叫指令</a></li><li><a href="/head-first-eof/EIP-7480.html" class="sidebar-link">EOF - 資料區段存取指令</a></li><li><a href="/head-first-eof/EIP-7620.html" class="sidebar-link">EIP-7620：EOF 合約部署新方式</a></li><li><a href="/head-first-eof/EIP-7698.html" class="sidebar-link">EIP-7698: EOF - 部署交易</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="eip-4750-eof-函式功能"><a href="#eip-4750-eof-函式功能" class="header-anchor">#</a> EIP-4750 EOF 函式功能</h1> <h2 id="注意事項"><a href="#注意事項" class="header-anchor">#</a> 注意事項</h2> <p>本文並沒有經過作者外的其他審查者審核，因此若內容有誤，請到 issue 區提出問題，我會儘速修改，謝謝。</p> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>想像你在寫一個程式，就像組裝樂高積木一樣。以前我們只能用一整條長長的指令來完成所有工作，但現在我們可以把程式分成很多小塊，每一塊都是一個「函式」（功能），就像把不同的樂高積木組合起來。</p> <p>引入這樣的特性，代表我們從過往沒有結構的傳統 EVM 程式碼，開始轉變成具備高度結構化的程式碼。透過這樣的改變能讓我們的程式碼更容易進行分析、最佳化、與理解。</p> <h2 id="這個改進想要解決什麼問題"><a href="#這個改進想要解決什麼問題" class="header-anchor">#</a> 這個改進想要解決什麼問題？</h2> <p>以前的程式就像一條長長的跑道，要跳來跳去很麻煩：</p> <ul><li>程式只能用「動態跳躍」，因此跑者無法在最初的時候知道跑道的真正軌跡，需要到正在跑的當下才會得知下一個目的地在哪（像隨便跳到某個地方）</li> <li>這樣很混亂，不只人類在分析與計算有難度，且電腦也很難在最佳化上有很好的做法</li> <li>更多的是我們還需要動態驗證許多的指令，以確保在執行期間不會出現問題，這樣將導致程式碼執行的成本被迫增加</li></ul> <h2 id="新的解決方案"><a href="#新的解決方案" class="header-anchor">#</a> 新的解決方案</h2> <p>現在我們引入了兩個新的指令：</p> <ol><li><strong><code>CALLF</code></strong>（呼叫函式）- 就像打電話給朋友請他幫忙</li> <li><strong><code>RETF</code></strong>（回傳結果）- 朋友做完事情後回電話告訴你結果</li></ol> <h2 id="如何運作"><a href="#如何運作" class="header-anchor">#</a> 如何運作？</h2> <h3 id="型態區段-type-section"><a href="#型態區段-type-section" class="header-anchor">#</a> 型態區段（Type Section）</h3> <p>每個函式都有一個標籤，告訴我們：</p> <ul><li>需要多少東西作為輸入（像食譜需要多少材料）</li> <li>會產生多少東西作為輸出（像食譜會做出多少個餅乾）</li> <li>最多會用到多少空間（像廚房檯面要多大）</li></ul> <div class="language-txt extra-class"><pre class="language-txt"><code>每個函式的資訊包含：
- 輸入數量：0-255
- 輸出數量：0-255  
- 最大堆疊增加：0-65535
</code></pre></div><h4 id="函式資料結構"><a href="#函式資料結構" class="header-anchor">#</a> 函式資料結構</h4> <div class="language-txt extra-class"><pre class="language-txt"><code>┌─────────────┬─────────────┬────────────────────┐
│  輸入數量   │  輸出數量   │ 最大堆疊增加量     │
│ (0~255)     │ (0~255)     │ (0~65535)          │
└─────────────┴─────────────┴────────────────────┘
</code></pre></div><h3 id="新的執行狀態-回傳堆疊-return-stack"><a href="#新的執行狀態-回傳堆疊-return-stack" class="header-anchor">#</a> 新的執行狀態：回傳堆疊（Return Stack）</h3> <p>EVM 現在有第二個堆疊：「回傳堆疊」，用來儲存函式呼叫的返回資訊。</p> <h4 id="回傳堆疊結構"><a href="#回傳堆疊結構" class="header-anchor">#</a> 回傳堆疊結構</h4> <ul><li><p>每次 <code>CALLF</code> 會壓入一個回傳項目：</p> <div class="language-text extra-class"><pre class="language-text"><code>(code_section_index = 呼叫前的區段,
 offset = CALLF 結束後的 PC)
</code></pre></div></li> <li><p>若回傳堆疊超過 1024 項目會中止</p></li> <li><p>呼叫時也會檢查 operand stack 是否會超過 1024 的限制（加上 callee 的最大堆疊增量）</p></li> <li><p><code>RETF</code> 從堆疊中取出該項，跳回呼叫處</p> <div class="language-text extra-class"><pre class="language-text"><code>最大容量：1024 個項目
</code></pre></div></li></ul> <h4 id="回傳堆疊操作示意"><a href="#回傳堆疊操作示意" class="header-anchor">#</a> 回傳堆疊操作示意</h4> <div class="language-text extra-class"><pre class="language-text"><code>初始時：
Return Stack: []

CALLF：
Return Stack: [（MainSection, offset=CALLF+2）]

CALLF（巢狀）：
Return Stack: [（MainSection, offset=CALLF+2), (Func1Section, offset=CALLF+2)]

RETF：
Return Stack: [(MainSection, offset=CALLF+2)]
→ 回到 Func1

RETF：
Return Stack: []
→ 回到 Main
</code></pre></div><h3 id="callf-指令-呼叫函式"><a href="#callf-指令-呼叫函式" class="header-anchor">#</a> <code>CALLF</code> 指令（呼叫函式）</h3> <div class="language-text extra-class"><pre class="language-text"><code>CALLF(target_section_index: u16)
</code></pre></div><ol><li><p>有一個 16-bit 無號整數參數（big-endian 編碼），代表要呼叫的目標程式區段。</p></li> <li><p>根據 <a href="/head-first-eof/eip-5450.html">EIP-5450</a> 驗證，保證 operand stack 有足夠輸入供目標函式使用。</p></li> <li><p>如果 <code>operand stack</code> 的目前高度 + <code>type[target_section_index].max_stack_increase</code> 超過 1024，會異常中止。</p></li> <li><p>若回傳堆疊已滿（1024 個項目），則異常中止。</p></li> <li><p>花費 5 單位 gas。</p></li> <li><p>不操作 operand stack。</p></li> <li><p>壓入 return stack：</p> <div class="language-text extra-class"><pre class="language-text"><code>(code_section_index = 呼叫前所在區段,
 offset = CALLF 指令後下一個指令位置)
</code></pre></div></li> <li><p>將 <code>current_section_index = target_section_index</code> 並將 PC 設為 0，開始執行新函式。</p></li></ol> <h3 id="retf-指令-回傳結果"><a href="#retf-指令-回傳結果" class="header-anchor">#</a> <code>RETF</code> 指令（回傳結果）</h3> <div class="language-text extra-class"><pre class="language-text"><code>RETF
</code></pre></div><ol><li>無參數。</li> <li>根據驗證，保證 operand stack 有正確數量的輸出值。</li> <li>花費 3 單位 gas。</li> <li>不操作 operand stack。</li> <li>從回傳堆疊取出物件 <code>(section, offset)</code>，跳回該位置繼續執行。</li></ol> <blockquote><p>根據驗證規則，0 號主程式區段不允許使用 <code>RETF</code>，其主因是在合法程式中執行 RETF 時，回傳堆疊必不為空，但在執行之初， 0 號主程式區段只能是空的回傳堆疊。</p></blockquote> <h3 id="callf-retf-執行流程圖"><a href="#callf-retf-執行流程圖" class="header-anchor">#</a> CALLF / RETF 執行流程圖</h3> <div class="language-text extra-class"><pre class="language-text"><code>┌────────────┐
│ 執行主程式 │
└─────┬──────┘
      │
      ▼
┌────────────┐
│  執行 CALLF │───┐
└─────┬──────┘   │
      │ 寫入返回位置
      ▼         │
┌────────────┐  │
│  進入函式區 │◀─┘
└─────┬──────┘
      │
      ▼
┌────────────┐
│ 執行 RETF   │────┐
└─────┬──────┘    │
      │ 讀取返回位置
      ▼            │
┌────────────┐   ◀─┘
│ 回主程式繼續 │
└────────────┘
</code></pre></div><h3 id="🧪-巢狀呼叫堆疊流程"><a href="#🧪-巢狀呼叫堆疊流程" class="header-anchor">#</a> 🧪 巢狀呼叫堆疊流程</h3> <div class="language-text extra-class"><pre class="language-text"><code>(0) Main Function
  ↓ CALLF(1)
(1) Function 1
  ↓ CALLF(2)
(2) Function 2
  ↓ RETF → 回到 Function 1
(1) Function 1
  ↓ RETF → 回到 Main Function
</code></pre></div><div class="language-text extra-class"><pre class="language-text"><code>堆疊變化：
Step 1: []
Step 2: [（0, Main_PC)]
Step 3: [(0, Main_PC), (1, Func1_PC)]
Step 4: [(0, Main_PC)]
Step 5: []
</code></pre></div><h3 id="程式碼驗證規則"><a href="#程式碼驗證規則" class="header-anchor">#</a> 程式碼驗證規則</h3> <p>為了確保程式碼正確，我們有這些規則：</p> <ol><li>不能呼叫不存在的函式</li> <li>跳躍指令不能跳到函式外面</li> <li>每個函式都要能從主程式到達，不可有死碼</li> <li>禁止使用舊的動態跳躍指令</li> <li>每個函式的返回堆疊必須在執行 RETF 前不為空</li></ol> <h3 id="被禁用的指令"><a href="#被禁用的指令" class="header-anchor">#</a> 被禁用的指令</h3> <p>以下指令在新版本中不能使用：</p> <ul><li><code>JUMP</code> 和 <code>JUMPI</code></li> <li><code>JUMPDEST</code>（轉為 <code>NOP</code> 無操作指令）</li> <li><code>PC</code></li></ul> <h2 id="執行過程"><a href="#執行過程" class="header-anchor">#</a> 執行過程</h2> <ol><li>程式從第 0 程式區段開始執行</li> <li>回傳堆疊初始為空</li> <li>除 <code>CALLF</code> 外，不需檢查堆疊高度限制</li></ol> <h2 id="為什麼這樣設計"><a href="#為什麼這樣設計" class="header-anchor">#</a> 為什麼這樣設計？</h2> <h3 id="讓-jumpdest-變成-nop"><a href="#讓-jumpdest-變成-nop" class="header-anchor">#</a> 讓 <code>JUMPDEST</code> 變成 <code>NOP</code></h3> <p>因為 <code>JUMPDEST</code> 原本只是跳躍標記，現在已不再需要：</p> <ol><li>可作為效能測試點</li> <li>幫助程式碼對齊</li> <li>作為佔位符指令使用</li></ol> <h3 id="不再需要掃描-jumpdest"><a href="#不再需要掃描-jumpdest" class="header-anchor">#</a> 不再需要掃描 <code>JUMPDEST</code></h3> <p>以前需掃描所有可能跳躍目標以進行驗證。現在使用靜態結構與相對位址後，這項工作不再必要，提升驗證與執行效率。</p> <h2 id="相容性"><a href="#相容性" class="header-anchor">#</a> 相容性</h2> <ul><li>僅適用於 EOFv1 格式的合約</li> <li>舊有合約完全不受影響</li></ul> <h2 id="花費成本"><a href="#花費成本" class="header-anchor">#</a> 花費成本</h2> <ul><li><code>CALLF</code>：5 Gas</li> <li><code>RETF</code>：3 Gas</li></ul> <h2 id="總結"><a href="#總結" class="header-anchor">#</a> 總結</h2> <p>EIP-4750 把以往「一條到底」的 EVM 程式，轉換成可以分段、結構化、具可讀性的函式程式風格。搭配回傳堆疊(return stack)的設計，不但使程式更容易分析與最佳化，就像從一堆線變成一組有邏輯的樂高積木，EVM 也即將迎來新的程式架構時代！</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/hydai/solidity.tw/edit/master/head-first-eof/EIP-4750.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2025/5/21 下午3:09:25</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/head-first-eof/EIP-4200.html" class="prev">
        EIP-4200：EOF - 靜態相對跳躍
      </a></span> <span class="next"><a href="/head-first-eof/EIP-5450.html">
        EOF - 堆疊驗證
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.03130786.js" defer></script><script src="/assets/js/2.ce7b5ffa.js" defer></script><script src="/assets/js/1.843ff0e7.js" defer></script><script src="/assets/js/59.c9dd68a1.js" defer></script>
  </body>
</html>
