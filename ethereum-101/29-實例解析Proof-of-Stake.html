<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>實例解析 - Proof of Stake 書籍的捐款合約 Part 7 (final) | 一本關於 Ethereum 與 Solidity 智能合約的書</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="在 2022 年，我們該如何學習智能合約開發">
    
    <link rel="preload" href="/assets/css/0.styles.9f477098.css" as="style"><link rel="preload" href="/assets/js/app.4cca3437.js" as="script"><link rel="preload" href="/assets/js/2.ce7b5ffa.js" as="script"><link rel="preload" href="/assets/js/1.843ff0e7.js" as="script"><link rel="preload" href="/assets/js/51.a77781e8.js" as="script"><link rel="prefetch" href="/assets/js/10.c12fac62.js"><link rel="prefetch" href="/assets/js/11.c2affc04.js"><link rel="prefetch" href="/assets/js/12.f054eba6.js"><link rel="prefetch" href="/assets/js/13.e4d40fa1.js"><link rel="prefetch" href="/assets/js/14.ed0a28d5.js"><link rel="prefetch" href="/assets/js/15.d25bd3fe.js"><link rel="prefetch" href="/assets/js/16.97c2c4a8.js"><link rel="prefetch" href="/assets/js/17.849d402a.js"><link rel="prefetch" href="/assets/js/18.cdc68d17.js"><link rel="prefetch" href="/assets/js/19.e30826d9.js"><link rel="prefetch" href="/assets/js/20.8effbcd5.js"><link rel="prefetch" href="/assets/js/21.9653cdd5.js"><link rel="prefetch" href="/assets/js/22.7dfb5581.js"><link rel="prefetch" href="/assets/js/23.406b22a7.js"><link rel="prefetch" href="/assets/js/24.6e97fe79.js"><link rel="prefetch" href="/assets/js/25.23463e33.js"><link rel="prefetch" href="/assets/js/26.af99b220.js"><link rel="prefetch" href="/assets/js/27.9685dd0d.js"><link rel="prefetch" href="/assets/js/28.f4af52c6.js"><link rel="prefetch" href="/assets/js/29.2e878408.js"><link rel="prefetch" href="/assets/js/3.16c4453f.js"><link rel="prefetch" href="/assets/js/30.e4bb639f.js"><link rel="prefetch" href="/assets/js/31.18b29900.js"><link rel="prefetch" href="/assets/js/32.682bc074.js"><link rel="prefetch" href="/assets/js/33.f59d47b4.js"><link rel="prefetch" href="/assets/js/34.80e5c005.js"><link rel="prefetch" href="/assets/js/35.70280677.js"><link rel="prefetch" href="/assets/js/36.9f1bcea0.js"><link rel="prefetch" href="/assets/js/37.86a5d290.js"><link rel="prefetch" href="/assets/js/38.74807ea4.js"><link rel="prefetch" href="/assets/js/39.2fec2772.js"><link rel="prefetch" href="/assets/js/4.7b5274ce.js"><link rel="prefetch" href="/assets/js/40.321fa430.js"><link rel="prefetch" href="/assets/js/41.1f2152ba.js"><link rel="prefetch" href="/assets/js/42.b0f532b4.js"><link rel="prefetch" href="/assets/js/43.e0690f4e.js"><link rel="prefetch" href="/assets/js/44.3d525c5f.js"><link rel="prefetch" href="/assets/js/45.e780fd6d.js"><link rel="prefetch" href="/assets/js/46.a01f013b.js"><link rel="prefetch" href="/assets/js/47.2941f6f7.js"><link rel="prefetch" href="/assets/js/48.ca95021b.js"><link rel="prefetch" href="/assets/js/49.8e4e06a7.js"><link rel="prefetch" href="/assets/js/5.a90aa973.js"><link rel="prefetch" href="/assets/js/50.76543ed3.js"><link rel="prefetch" href="/assets/js/52.522cda49.js"><link rel="prefetch" href="/assets/js/53.735682d0.js"><link rel="prefetch" href="/assets/js/54.6df62ee1.js"><link rel="prefetch" href="/assets/js/55.85e692df.js"><link rel="prefetch" href="/assets/js/6.acf7bb6e.js"><link rel="prefetch" href="/assets/js/7.dfcce160.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.d9dffa33.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9f477098.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">一本關於 Ethereum 與 Solidity 智能合約的書</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首頁
</a></div><div class="nav-item"><a href="/ethereum-101/" class="nav-link router-link-active">
  那些關於 Ethereum 的事
</a></div><div class="nav-item"><a href="https://youtube.com/playlist?list=PLHmOMPRfmOxQYDnXAc1hKY6ra4WDU8ZlM" target="_blank" rel="noopener noreferrer" class="nav-link external">
  在 2022 年，我們該如何寫智能合約
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://www.youtube.com/playlist?list=PLHmOMPRfmOxTiqyaSu1EXs8ioESZtOSHN" target="_blank" rel="noopener noreferrer" class="nav-link external">
  淺入淺出 EVM Object Format
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/hydai/solidity.tw" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首頁
</a></div><div class="nav-item"><a href="/ethereum-101/" class="nav-link router-link-active">
  那些關於 Ethereum 的事
</a></div><div class="nav-item"><a href="https://youtube.com/playlist?list=PLHmOMPRfmOxQYDnXAc1hKY6ra4WDU8ZlM" target="_blank" rel="noopener noreferrer" class="nav-link external">
  在 2022 年，我們該如何寫智能合約
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://www.youtube.com/playlist?list=PLHmOMPRfmOxTiqyaSu1EXs8ioESZtOSHN" target="_blank" rel="noopener noreferrer" class="nav-link external">
  淺入淺出 EVM Object Format
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/hydai/solidity.tw" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Ethereum 101</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/ethereum-101/" aria-current="page" class="sidebar-link">那些關於 Ethereum 的事</a></li><li><a href="/ethereum-101/01-什麼是區塊鏈.html" class="sidebar-link">什麼是區塊鏈？</a></li><li><a href="/ethereum-101/02-什麼是區塊什麼是鏈.html" class="sidebar-link">何謂區塊？何謂鏈？</a></li><li><a href="/ethereum-101/03-什麼是交易.html" class="sidebar-link">什麼是交易（Transaction）</a></li><li><a href="/ethereum-101/04-燃料與手續費.html" class="sidebar-link">燃料（Gas）與手續費（Fee）</a></li><li><a href="/ethereum-101/05-帳戶.html" class="sidebar-link">帳戶（Account）</a></li><li><a href="/ethereum-101/06-網路.html" class="sidebar-link">網路（Network）</a></li><li><a href="/ethereum-101/07-共識機制.html" class="sidebar-link">共識機制</a></li><li><a href="/ethereum-101/08-工作量證明.html" class="sidebar-link">工作量證明（Proof-of-Work）</a></li><li><a href="/ethereum-101/09-權益證明.html" class="sidebar-link">權益證明（Proof-of-Stake）</a></li><li><a href="/ethereum-101/10-以太坊生態系的不同層級.html" class="sidebar-link">以太坊生態系的不同層級</a></li><li><a href="/ethereum-101/11-以太坊改良提案.html" class="sidebar-link">以太坊改良提案 Ethereum Improvement Proposals (EIP)</a></li><li><a href="/ethereum-101/12-以太坊請求意見稿.html" class="sidebar-link">以太坊請求意見稿 Ethereum Request for Comments (ERC)</a></li><li><a href="/ethereum-101/13-ERC20代幣標準.html" class="sidebar-link">ERC20 代幣標準</a></li><li><a href="/ethereum-101/14-ERC20例子.html" class="sidebar-link">ERC20 例子</a></li><li><a href="/ethereum-101/15-ERC721非同值性代幣（NFT）標準.html" class="sidebar-link">ERC721 非同值性代幣（NFT）標準</a></li><li><a href="/ethereum-101/16-ERC721的元資料擴充（metadata）.html" class="sidebar-link">ERC721 的元資料擴充（metadata extension）</a></li><li><a href="/ethereum-101/17-ERC721的列舉擴充.html" class="sidebar-link">ERC721 的列舉擴充（enumeration extension）</a></li><li><a href="/ethereum-101/18-ERC721A的改進.html" class="sidebar-link">ERC721A 的改進</a></li><li><a href="/ethereum-101/19-ERC721R-有鑑賞期的NFT.html" class="sidebar-link">ERC721R - 有鑑賞期的 NFT</a></li><li><a href="/ethereum-101/20-ERC1155多元代幣標準.html" class="sidebar-link">ERC1155 多元代幣標準 - ERC20 + ERC721 我全都要</a></li><li><a href="/ethereum-101/21-ERC1155的案例.html" class="sidebar-link">ERC1155 的案例</a></li><li><a href="/ethereum-101/22-POAP參與證明.html" class="sidebar-link">POAP - Proof Of Attendance Protocol 參與證明</a></li><li><a href="/ethereum-101/23-實例解析Proof-of-Stake.html" class="sidebar-link">實例解析 - Proof of Stake 書籍的捐款合約 Part 1</a></li><li><a href="/ethereum-101/24-實例解析Proof-of-Stake.html" class="sidebar-link">實例解析 - Proof of Stake 書籍的捐款合約 Part 2</a></li><li><a href="/ethereum-101/25-實例解析Proof-of-Stake.html" class="sidebar-link">實例解析 - Proof of Stake 書籍的捐款合約 Part 3</a></li><li><a href="/ethereum-101/26-實例解析Proof-of-Stake.html" class="sidebar-link">實例解析 - Proof of Stake 書籍的捐款合約 Part 4</a></li><li><a href="/ethereum-101/27-實例解析Proof-of-Stake.html" class="sidebar-link">實例解析 - Proof of Stake 書籍的捐款合約 Part 5</a></li><li><a href="/ethereum-101/28-實例解析Proof-of-Stake.html" class="sidebar-link">實例解析 - Proof of Stake 書籍的捐款合約 Part 6</a></li><li><a href="/ethereum-101/29-實例解析Proof-of-Stake.html" class="active sidebar-link">實例解析 - Proof of Stake 書籍的捐款合約 Part 7 (final)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ethereum-101/29-實例解析Proof-of-Stake.html#合約原始碼" class="sidebar-link">合約原始碼</a></li></ul></li><li><a href="/ethereum-101/30-結語.html" class="sidebar-link">結語</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="實例解析-proof-of-stake-書籍的捐款合約-part-7-final"><a href="#實例解析-proof-of-stake-書籍的捐款合約-part-7-final" class="header-anchor">#</a> 實例解析 - Proof of Stake 書籍的捐款合約 Part 7 (final)</h1> <h2 id="合約原始碼"><a href="#合約原始碼" class="header-anchor">#</a> 合約原始碼</h2> <p><a href="https://etherscan.io/address/0x5bf5bcc5362f88721167c1068b58c60cad075aac#code" target="_blank" rel="noopener noreferrer">合約原始碼請點此<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="proofofstake-pages-sol-引用的函式庫與介面"><a href="#proofofstake-pages-sol-引用的函式庫與介面" class="header-anchor">#</a> <code>ProofOfStake_Pages.sol</code> 引用的函式庫與介面</h3> <p>ProofOfStake_Pages 合約中引入的函式庫與介面，可以看到以下的結構(<code>*</code> 為本日說明的範圍)</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code>ProofOfStake_Pages<span class="token operator">*</span>
<span class="token operator">|</span><span class="token operator">-</span> <span class="token punctuation">(</span>Part <span class="token number">3</span><span class="token punctuation">)</span> Ownable<span class="token punctuation">.</span>sol
<span class="token operator">|</span>  <span class="token operator">|</span><span class="token operator">-</span> <span class="token punctuation">(</span>Part <span class="token number">2</span><span class="token punctuation">)</span> Context<span class="token punctuation">.</span>sol
<span class="token operator">|</span><span class="token operator">-</span> <span class="token punctuation">(</span>Part <span class="token number">3</span><span class="token punctuation">)</span> ReentrancyGuard<span class="token punctuation">.</span>sol
<span class="token operator">|</span><span class="token operator">-</span> <span class="token punctuation">(</span>Part <span class="token number">6</span><span class="token punctuation">)</span> ERC721Enumerable<span class="token punctuation">.</span>sol
<span class="token operator">|</span>  <span class="token operator">|</span><span class="token operator">-</span> <span class="token punctuation">(</span>Part <span class="token number">6</span><span class="token punctuation">)</span> ERC721<span class="token punctuation">.</span>sol
<span class="token operator">|</span>  <span class="token operator">|</span>  <span class="token operator">|</span><span class="token operator">-</span> <span class="token punctuation">(</span>前文<span class="token punctuation">)</span> IERC721<span class="token punctuation">.</span>sol
<span class="token operator">|</span>  <span class="token operator">|</span>     <span class="token operator">|</span><span class="token operator">-</span> <span class="token punctuation">(</span>Part <span class="token number">5</span><span class="token punctuation">)</span> IERC165<span class="token punctuation">.</span>sol
<span class="token operator">|</span>  <span class="token operator">|</span>  <span class="token operator">|</span><span class="token operator">-</span> <span class="token punctuation">(</span>Part <span class="token number">5</span><span class="token punctuation">)</span> IERC721Receiver<span class="token punctuation">.</span>sol
<span class="token operator">|</span>  <span class="token operator">|</span>  <span class="token operator">|</span><span class="token operator">-</span> <span class="token punctuation">(</span>前文<span class="token punctuation">)</span> IERC721Metadata<span class="token punctuation">.</span>sol
<span class="token operator">|</span>  <span class="token operator">|</span>  <span class="token operator">|</span><span class="token operator">-</span> <span class="token punctuation">(</span>Part <span class="token number">4</span><span class="token punctuation">)</span> Address<span class="token punctuation">.</span>sol
<span class="token operator">|</span>  <span class="token operator">|</span>  <span class="token operator">|</span><span class="token operator">-</span> <span class="token punctuation">(</span>Part <span class="token number">2</span><span class="token punctuation">)</span> Context<span class="token punctuation">.</span>sol
<span class="token operator">|</span>  <span class="token operator">|</span>  <span class="token operator">|</span><span class="token operator">-</span> <span class="token punctuation">(</span>Part <span class="token number">2</span><span class="token punctuation">)</span> Strings<span class="token punctuation">.</span>sol
<span class="token operator">|</span>  <span class="token operator">|</span>  <span class="token operator">|</span><span class="token operator">-</span> <span class="token punctuation">(</span>Part <span class="token number">5</span><span class="token punctuation">)</span> ERC165<span class="token punctuation">.</span>sol
<span class="token operator">|</span>  <span class="token operator">|</span><span class="token operator">-</span> <span class="token punctuation">(</span>前文<span class="token punctuation">)</span> IERC721Enumerable<span class="token punctuation">.</span>sol
<span class="token operator">|</span>  <span class="token operator">|</span>  <span class="token operator">|</span><span class="token operator">-</span> <span class="token punctuation">(</span>前文<span class="token punctuation">)</span> IERC721<span class="token punctuation">.</span>sol
<span class="token operator">|</span>  <span class="token operator">|</span>     <span class="token operator">|</span><span class="token operator">-</span> <span class="token punctuation">(</span>Part <span class="token number">5</span><span class="token punctuation">)</span> IERC165<span class="token punctuation">.</span>sol
<span class="token operator">|</span><span class="token operator">-</span> <span class="token punctuation">(</span>Part <span class="token number">2</span><span class="token punctuation">)</span> Strings<span class="token punctuation">.</span>sol
<span class="token operator">|</span><span class="token operator">-</span> <span class="token punctuation">(</span>Part <span class="token number">2</span><span class="token punctuation">)</span> Counters<span class="token punctuation">.</span>sol
<span class="token operator">|</span><span class="token operator">-</span> <span class="token punctuation">(</span>Part <span class="token number">1</span><span class="token punctuation">)</span> base64<span class="token punctuation">.</span>sol
<span class="token operator">|</span><span class="token operator">-</span> <span class="token punctuation">(</span>Part <span class="token number">1</span><span class="token punctuation">)</span>Transforms<span class="token punctuation">.</span>sol
</code></pre></div><h3 id="主菜-proofofstake-pages-sol"><a href="#主菜-proofofstake-pages-sol" class="header-anchor">#</a> 主菜：<code>ProofOfStake_Pages.sol</code></h3> <p>這個 NFT 在設計時引入的 Soulbound (靈魂綁定的概念)，因此在 NFT 被鑄造出來後，便禁止轉移與授權相關的函式，只有捐款者本人才能持有。</p> <p>細節請看程式碼註解。</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">&gt;=</span><span class="token version number">0.8.0</span> <span class="token operator">&lt;</span><span class="token version number">0.9.0</span><span class="token punctuation">;</span>

<span class="token comment">//SPDX-License-Identifier: Apache-2.0</span>
<span class="token keyword">import</span> <span class="token string">&quot;@openzeppelin/contracts/access/Ownable.sol&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">&quot;@openzeppelin/contracts/security/ReentrancyGuard.sol&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">&quot;@openzeppelin/contracts/token/ERC721/extensions/ERC721Enumerable.sol&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">&quot;@openzeppelin/contracts/utils/Strings.sol&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">&quot;@openzeppelin/contracts/utils/Counters.sol&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>Base64<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;base64-sol/base64.sol&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>Transforms<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./libs/Transforms.sol&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 宣告錯誤型態</span>
error <span class="token function">Soulbound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 靈魂綁定</span>
error <span class="token function">PledgingDisabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 關閉捐款</span>
error <span class="token function">NotMinimumPledge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 未達最低捐款額度</span>
error <span class="token function">SendFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 發送失敗</span>
error <span class="token function">InvalidSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不合法的簽名</span>
error <span class="token function">ZeroSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// address 0 的簽名</span>
error <span class="token function">DoesNotExist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不存在</span>

<span class="token comment">// 提供將 addresses 解碼成對應的 ENS 的介面</span>
abstract <span class="token keyword">contract</span> <span class="token class-name">ENS_Resolver</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">getNames</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">calldata</span> addresses<span class="token punctuation">)</span>
        <span class="token keyword">external</span>
        <span class="token keyword">view</span>
        virtual
        <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 本合約繼承了 ERC721Enumerable, Ownable, 與 ReentrancyGuard 三大合約，而他們彼此還有各自的繼承，可以從前幾篇文章找到</span>
<span class="token keyword">contract</span> <span class="token class-name">ProofOfStake_Pages</span> <span class="token keyword">is</span> ERC721Enumerable<span class="token punctuation">,</span> Ownable<span class="token punctuation">,</span> ReentrancyGuard <span class="token punctuation">{</span>
    ENS_Resolver res <span class="token operator">=</span> <span class="token function">ENS_Resolver</span><span class="token punctuation">(</span><span class="token number">0x3671aE578E63FdF66ad4F3E12CC0c0d71Ac7510C</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">using</span> <span class="token class-name">Counters</span> <span class="token keyword">for</span> Counters<span class="token punctuation">.</span>Counter<span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token class-name">Strings</span> <span class="token keyword">for</span> <span class="token builtin">uint256</span><span class="token punctuation">;</span>

    <span class="token comment">/*///////////////////////////////////////////////////////////////
                            TOKEN STORAGE
    //////////////////////////////////////////////////////////////*/</span>

    Counters<span class="token punctuation">.</span>Counter <span class="token keyword">private</span> _tokenIds<span class="token punctuation">;</span>

    <span class="token builtin">bool</span> <span class="token keyword">public</span> pledgeOpen<span class="token punctuation">;</span>

    <span class="token comment">// confirm with team</span>
    <span class="token builtin">uint256</span> <span class="token keyword">internal</span> <span class="token keyword">constant</span> price <span class="token operator">=</span> <span class="token number">0.0001337</span> ether<span class="token punctuation">;</span>

    <span class="token builtin">uint256</span> <span class="token keyword">internal</span> <span class="token keyword">constant</span> tokenlimitperuser <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token builtin">uint256</span> <span class="token keyword">internal</span> <span class="token keyword">constant</span> publisherSplit <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=&gt;</span> <span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token keyword">public</span> pledgeLimit<span class="token punctuation">;</span>

    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=&gt;</span> <span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token keyword">public</span> udonationTotal<span class="token punctuation">;</span>

    <span class="token comment">//prettier-ignore</span>
    <span class="token builtin">address</span> <span class="token keyword">internal</span> immutable gitcoin <span class="token operator">=</span> <span class="token number">0xde21F729137C5Af1b01d73aF1dC21eFfa2B8a0d6</span><span class="token punctuation">;</span>

    <span class="token comment">//prettier-ignore</span>
    <span class="token builtin">address</span> <span class="token keyword">internal</span> immutable sevenStories <span class="token operator">=</span> <span class="token number">0x209D3040C2dEdcb7124be89Fc6849423621EdeaC</span><span class="token punctuation">;</span>

    <span class="token builtin">string</span> <span class="token keyword">public</span> contractAddressString <span class="token operator">=</span>
        Transforms<span class="token punctuation">.</span><span class="token function">toAsciiString</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token builtin">string</span> <span class="token keyword">public</span> currentMessage<span class="token punctuation">;</span>

    <span class="token comment">// 定義 NFT 的資料結構</span>
    <span class="token keyword">struct</span> <span class="token class-name">Token</span> <span class="token punctuation">{</span>
        <span class="token builtin">string</span> recipient<span class="token punctuation">;</span>
        <span class="token builtin">address</span> rAddress<span class="token punctuation">;</span>
        <span class="token builtin">string</span> sigValue<span class="token punctuation">;</span>
        <span class="token builtin">string</span> timestamp<span class="token punctuation">;</span>
        <span class="token builtin">string</span> writtenMsg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Token<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">private</span> tokens<span class="token punctuation">;</span>

    <span class="token comment">/*///////////////////////////////////////////////////////////////
                               EVENTS
    //////////////////////////////////////////////////////////////*/</span>

    <span class="token keyword">event</span> <span class="token function">Pledge</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">indexed</span> pledgee<span class="token punctuation">,</span> <span class="token builtin">uint256</span> <span class="token keyword">indexed</span> pledgeValue<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*///////////////////////////////////////////////////////////////
                           EIP-712 STORAGE
    //////////////////////////////////////////////////////////////*/</span>

    <span class="token comment">// 寫死 vitalik 的位址</span>
    <span class="token comment">//prettier-ignore</span>
    <span class="token builtin">address</span> <span class="token keyword">internal</span> immutable vitalik <span class="token operator">=</span> <span class="token number">0xd8dA6BF26964aF9D7eEd9e03E53415D37aA96045</span><span class="token punctuation">;</span>

    <span class="token builtin">uint256</span> <span class="token keyword">internal</span> immutable INITIAL_CHAIN_ID<span class="token punctuation">;</span>

    <span class="token builtin">bytes32</span> <span class="token keyword">internal</span> immutable INITIAL_DOMAIN_SEPARATOR<span class="token punctuation">;</span>

    <span class="token builtin">bytes32</span> <span class="token keyword">public</span> <span class="token keyword">constant</span> AUTOGRAPH_TYPEHASH <span class="token operator">=</span>
        <span class="token function">keccak256</span><span class="token punctuation">(</span>
            <span class="token string">&quot;signature(address sender,address recipient,string pledge,string timestamp,string msg)&quot;</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*///////////////////////////////////////////////////////////////
                              STRUCTOR
    //////////////////////////////////////////////////////////////*/</span>

    <span class="token comment">// 建構子，允許在建構新合約的當下，鑄造已經捐款者的 NFT</span>
    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> _donors<span class="token punctuation">,</span> <span class="token builtin">uint256</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> _amounts<span class="token punctuation">)</span>
        <span class="token function">ERC721</span><span class="token punctuation">(</span><span class="token string">&quot;Proof Of Stake Pages&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;PoSp&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">transferOwnership</span><span class="token punctuation">(</span><span class="token number">0xb010ca9Be09C382A9f31b79493bb232bCC319f01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 設定發行此合約的 chain id 用來驗證簽名</span>
        INITIAL_CHAIN_ID <span class="token operator">=</span> block<span class="token punctuation">.</span>chainid<span class="token punctuation">;</span>
        INITIAL_DOMAIN_SEPARATOR <span class="token operator">=</span> <span class="token function">computeDomainSeparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 發行 NFT 給已經捐款者</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> _donors<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pledgeLimit<span class="token punctuation">[</span>_donors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> pledgeLimit<span class="token punctuation">[</span>_donors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

            <span class="token builtin">string</span> <span class="token keyword">memory</span> resolved <span class="token operator">=</span> <span class="token function">resolveENS</span><span class="token punctuation">(</span>_donors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            udonationTotal<span class="token punctuation">[</span>_donors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">+=</span> _amounts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

            _tokenIds<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token builtin">uint256</span> id <span class="token operator">=</span> _tokenIds<span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">_mint</span><span class="token punctuation">(</span>_donors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

            tokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
                <span class="token function">Token</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    recipient<span class="token punctuation">:</span> resolved<span class="token punctuation">,</span>
                    rAddress<span class="token punctuation">:</span> _donors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
                    sigValue<span class="token punctuation">:</span> _amounts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    timestamp<span class="token punctuation">:</span> block<span class="token punctuation">.</span>timestamp<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    writtenMsg<span class="token punctuation">:</span> <span class="token string">&quot;Thank you for believing.&quot;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">emit</span> <span class="token function">Pledge</span><span class="token punctuation">(</span>_donors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> _amounts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*///////////////////////////////////////////////////////////////
                             PLEDGE LOGIC
    //////////////////////////////////////////////////////////////*/</span>

    <span class="token comment">// 捐款（原則上，這個合約的 NFT 是在這邊被鑄造出來的）</span>
    <span class="token comment">/**
     * @notice Pledges ETH to GTC &amp; &quot;whitelists&quot; pledger
     */</span>
    <span class="token comment">//prettier-ignore</span>
    <span class="token keyword">function</span> <span class="token function">pledge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">payable</span> nonReentrant <span class="token punctuation">{</span>
        <span class="token comment">// 若捐款關閉中，則觸發錯誤</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pledgeOpen <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">revert</span> <span class="token function">PledgingDisabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 若捐款的錢低於門檻，觸發錯誤</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value <span class="token operator">&lt;</span> price<span class="token punctuation">)</span> <span class="token keyword">revert</span> <span class="token function">NotMinimumPledge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token builtin">string</span> <span class="token keyword">memory</span> resolved <span class="token operator">=</span> <span class="token function">resolveENS</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 計算發行商的分潤</span>
        <span class="token builtin">uint</span> sShare <span class="token operator">=</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value <span class="token operator">*</span> publisherSplit<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">;</span>

        <span class="token comment">// 若呼叫者捐款多次，會更新在 NFT 上</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pledgeLimit<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">&gt;=</span> tokenlimitperuser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 發送部分收入給 gitcoin</span>
            <span class="token punctuation">(</span><span class="token builtin">bool</span> success3<span class="token punctuation">,</span> <span class="token punctuation">)</span> <span class="token operator">=</span> gitcoin<span class="token punctuation">.</span>call<span class="token punctuation">{</span>value<span class="token punctuation">:</span> msg<span class="token punctuation">.</span>value <span class="token operator">-</span> sShare<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success3<span class="token punctuation">)</span> <span class="token keyword">revert</span> <span class="token function">SendFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
            <span class="token comment">// 發送分潤給發行商 sevenStories</span>
            <span class="token punctuation">(</span><span class="token builtin">bool</span> success4<span class="token punctuation">,</span> <span class="token punctuation">)</span> <span class="token operator">=</span> sevenStories<span class="token punctuation">.</span>call<span class="token punctuation">{</span>value<span class="token punctuation">:</span> sShare<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success4<span class="token punctuation">)</span> <span class="token keyword">revert</span> <span class="token function">SendFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
            <span class="token comment">// 更新捐款紀錄</span>
            udonationTotal<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+=</span>  msg<span class="token punctuation">.</span>value<span class="token punctuation">;</span>

            <span class="token comment">// 更新捐款次數</span>
            pledgeLimit<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">=</span> pledgeLimit<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 反之，這是呼叫者的第一次捐款</span>
        <span class="token comment">// 先發送部分收入給 gitcoin</span>
        <span class="token punctuation">(</span><span class="token builtin">bool</span> success<span class="token punctuation">,</span> <span class="token punctuation">)</span> <span class="token operator">=</span> gitcoin<span class="token punctuation">.</span>call<span class="token punctuation">{</span>value<span class="token punctuation">:</span> msg<span class="token punctuation">.</span>value <span class="token operator">-</span> sShare<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token keyword">revert</span> <span class="token function">SendFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 再發送分潤給發行商 sevenStories</span>
        <span class="token punctuation">(</span><span class="token builtin">bool</span> success2<span class="token punctuation">,</span> <span class="token punctuation">)</span> <span class="token operator">=</span> sevenStories<span class="token punctuation">.</span>call<span class="token punctuation">{</span>value<span class="token punctuation">:</span> sShare<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success2<span class="token punctuation">)</span> <span class="token keyword">revert</span> <span class="token function">SendFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 更新發送者的捐款紀錄</span>
        udonationTotal<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+=</span>  msg<span class="token punctuation">.</span>value<span class="token punctuation">;</span>

        <span class="token comment">// 更新發送者的捐款次數</span>
        pledgeLimit<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">=</span> pledgeLimit<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token comment">// 建立新的 token ID</span>
        _tokenIds<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 取得新的 token ID</span>
        <span class="token builtin">uint256</span> id <span class="token operator">=</span> _tokenIds<span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 利用新 ID 來鑄造 NFT 給捐款者</span>
        <span class="token function">_mint</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 將新代幣加入代幣列表中</span>
        tokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">Token</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                recipient<span class="token punctuation">:</span> resolved<span class="token punctuation">,</span> <span class="token comment">/* 捐款者的 ENS */</span>
                rAddress<span class="token punctuation">:</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> <span class="token comment">/* 捐款者的位址 */</span>
                sigValue<span class="token punctuation">:</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/* 捐款者的捐款數量 */</span>
                timestamp<span class="token punctuation">:</span> block<span class="token punctuation">.</span>timestamp<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/* 捐款當下區塊的時間 */</span>
                writtenMsg<span class="token punctuation">:</span> currentMessage <span class="token comment">/* 當前 Vitalik 留下的訊息 */</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 觸發捐款事件</span>
        <span class="token keyword">emit</span> <span class="token function">Pledge</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 設定訊息</span>
    <span class="token comment">// 只有 vitalik 才能觸發</span>
    <span class="token keyword">function</span> <span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token builtin">string</span> <span class="token keyword">calldata</span> _message<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> vitalik<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>_message<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        currentMessage <span class="token operator">=</span> _message<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 解析特定位址對應的 ENS </span>
    <span class="token keyword">function</span> <span class="token function">resolveENS</span><span class="token punctuation">(</span><span class="token builtin">address</span> _user<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">string</span> <span class="token keyword">memory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin">string</span> <span class="token keyword">memory</span> resolved<span class="token punctuation">;</span>

        <span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> forCall <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        forCall<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> _user<span class="token punctuation">;</span>

        <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> callres <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">getNames</span><span class="token punctuation">(</span>forCall<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>callres<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            resolved <span class="token operator">=</span> <span class="token builtin">string</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">&quot;0x&quot;</span><span class="token punctuation">,</span> Transforms<span class="token punctuation">.</span><span class="token function">toAsciiString</span><span class="token punctuation">(</span>_user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            resolved <span class="token operator">=</span> callres<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> resolved<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 更新使用者的 NFT，當本合約收到來自 Vitalik 的合法簽名訊息</span>
    <span class="token comment">/**
     * @notice Updates the user token if we have a valid msg from Vitalik
     */</span>
    <span class="token comment">//prettier-ignore</span>
    <span class="token keyword">function</span> <span class="token function">updateIfSigned</span><span class="token punctuation">(</span>
        <span class="token builtin">bytes</span> <span class="token keyword">calldata</span> _signature<span class="token punctuation">,</span>
        <span class="token builtin">string</span> <span class="token keyword">calldata</span> _sigValue<span class="token punctuation">,</span>
        <span class="token builtin">string</span> <span class="token keyword">calldata</span> _timestamp<span class="token punctuation">,</span>
        <span class="token builtin">string</span> <span class="token keyword">calldata</span> _message
    <span class="token punctuation">)</span> <span class="token keyword">external</span> nonReentrant <span class="token punctuation">{</span>

        <span class="token punctuation">(</span><span class="token builtin">uint8</span> v<span class="token punctuation">,</span> <span class="token builtin">bytes32</span> r<span class="token punctuation">,</span> <span class="token builtin">bytes32</span> s<span class="token punctuation">)</span> <span class="token operator">=</span> Transforms<span class="token punctuation">.</span><span class="token function">splitSignature</span><span class="token punctuation">(</span>_signature<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token builtin">bytes32</span> hashStruct <span class="token operator">=</span> <span class="token function">keccak256</span><span class="token punctuation">(</span>
            abi<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>
                AUTOGRAPH_TYPEHASH<span class="token punctuation">,</span>
                <span class="token comment">// Will be wockis address in live v</span>
                vitalik<span class="token punctuation">,</span>
                <span class="token comment">// Signature will be invalid if it isn't to caller &amp;&amp;</span>
                <span class="token comment">// EIP712: &quot;Addresses are encoded as uint160&quot;</span>
                <span class="token builtin">uint160</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">// EIP712: &quot;values bytes and string are encoded as a keccak256 hash&quot;</span>
                <span class="token function">keccak256</span><span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>_sigValue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">keccak256</span><span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>_timestamp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">keccak256</span><span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>_message<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token builtin">bytes32</span> hash <span class="token operator">=</span> <span class="token function">keccak256</span><span class="token punctuation">(</span>
            abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span><span class="token string">&quot;\x19\x01&quot;</span><span class="token punctuation">,</span> <span class="token function">DOMAIN_SEPARATOR</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hashStruct<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">address</span> signer <span class="token operator">=</span> <span class="token function">ecrecover</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> v<span class="token punctuation">,</span> r<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>signer <span class="token operator">!=</span> vitalik<span class="token punctuation">)</span> <span class="token keyword">revert</span> <span class="token function">InvalidSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>signer <span class="token operator">==</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">revert</span> <span class="token function">ZeroSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token builtin">uint256</span> tokenid <span class="token operator">=</span> <span class="token function">tokenOfOwnerByIndex</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

        tokens<span class="token punctuation">[</span>tokenid<span class="token punctuation">]</span><span class="token punctuation">.</span>writtenMsg <span class="token operator">=</span> _message<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 切換捐款開關</span>
    <span class="token comment">/**
     * @notice Toggles Pledging On / Off
     */</span>
    <span class="token keyword">function</span> <span class="token function">togglePledging</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> onlyOwner <span class="token punctuation">{</span>
        pledgeOpen <span class="token operator">==</span> <span class="token boolean">false</span> <span class="token operator">?</span> pledgeOpen <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token punctuation">:</span> pledgeOpen <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*///////////////////////////////////////////////////////////////
                            TOKEN LOGIC
    //////////////////////////////////////////////////////////////*/</span>

    <span class="token comment">// 由於本合約發出的 NFT 為靈魂綁定代幣，因此封印轉移相關函式</span>
    <span class="token comment">/**
     * @notice SOULBOUND: Block transfers.
     */</span>
    <span class="token keyword">function</span> <span class="token function">_beforeTokenTransfer</span><span class="token punctuation">(</span>
        <span class="token builtin">address</span> <span class="token keyword">from</span><span class="token punctuation">,</span>
        <span class="token builtin">address</span> to<span class="token punctuation">,</span>
        <span class="token builtin">uint256</span> tokenId
    <span class="token punctuation">)</span> <span class="token keyword">internal</span> virtual <span class="token function">override</span><span class="token punctuation">(</span>ERC721Enumerable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>
            <span class="token keyword">from</span> <span class="token operator">==</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> to <span class="token operator">==</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">&quot;SOULBOUND: Non-Transferable&quot;</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        super<span class="token punctuation">.</span><span class="token function">_beforeTokenTransfer</span><span class="token punctuation">(</span><span class="token keyword">from</span><span class="token punctuation">,</span> to<span class="token punctuation">,</span> tokenId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 由於本合約發出的 NFT 為靈魂綁定代幣，因此封印授權相關函式</span>
    <span class="token comment">/**
     * @notice SOULBOUND: Block approvals.
     */</span>
    <span class="token keyword">function</span> <span class="token function">setApprovalForAll</span><span class="token punctuation">(</span><span class="token builtin">address</span> operator<span class="token punctuation">,</span> <span class="token builtin">bool</span> _approved<span class="token punctuation">)</span>
        <span class="token keyword">public</span>
        virtual
        <span class="token function">override</span><span class="token punctuation">(</span>ERC721<span class="token punctuation">,</span> IERC721<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">revert</span> <span class="token function">Soulbound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 由於本合約發出的 NFT 為靈魂綁定代幣，因此封印授權相關函式</span>
    <span class="token comment">/**
     * @notice SOULBOUND: Block approvals.
     */</span>
    <span class="token keyword">function</span> <span class="token function">approve</span><span class="token punctuation">(</span><span class="token builtin">address</span> to<span class="token punctuation">,</span> <span class="token builtin">uint256</span> tokenId<span class="token punctuation">)</span>
        <span class="token keyword">public</span>
        virtual
        <span class="token function">override</span><span class="token punctuation">(</span>ERC721<span class="token punctuation">,</span> IERC721<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">revert</span> <span class="token function">Soulbound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 用來產生 SVG 的函式，只需要留意裡面用到的變數即可</span>
    <span class="token comment">/**
     * @notice Generate SVG using tParams by index
     */</span>
    <span class="token keyword">function</span> <span class="token function">generateSVG</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> id<span class="token punctuation">)</span> <span class="token keyword">private</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bytes</span> <span class="token keyword">memory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin">bytes</span> <span class="token keyword">memory</span> eth<span class="token punctuation">;</span>

        <span class="token builtin">bytes</span> <span class="token keyword">memory</span> message<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>tokens<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>writtenMsg<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            message <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>
                abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>
                    <span class="token string">'&lt;tspan text-anchor=&quot;middle&quot; x=&quot;37.5%&quot; y=&quot;120&quot;&gt;'</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;&lt;/tspan&gt;&quot;</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            message <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>
                abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>
                    <span class="token string">'&lt;tspan text-anchor=&quot;middle&quot; x=&quot;37.5%&quot; y=&quot;120&quot;&gt;&quot;'</span><span class="token punctuation">,</span>
                    tokens<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>writtenMsg<span class="token punctuation">,</span>
                    <span class="token string">'&quot;&lt;/tspan&gt;'</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token builtin">uint256</span> eth1 <span class="token operator">=</span> udonationTotal<span class="token punctuation">[</span>tokens<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>rAddress<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token builtin">uint256</span> eth3 <span class="token operator">=</span> eth1 <span class="token operator">/</span> <span class="token number">1</span> ether<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>eth1 <span class="token operator">&lt;=</span> <span class="token number">999999999999999999</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            eth <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>
                abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>
                    <span class="token string">'&lt;tspan text-anchor=&quot;middle&quot; x=&quot;37.5%&quot; y=&quot;260&quot;&gt;'</span><span class="token punctuation">,</span>
                    eth1<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token string">&quot; (wei)&quot;</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;&lt;/tspan&gt;&quot;</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            eth <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>
                abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>
                    <span class="token string">'&lt;tspan text-anchor=&quot;middle&quot; x=&quot;37.5%&quot; y=&quot;260&quot;&gt;'</span><span class="token punctuation">,</span>
                    eth3<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token string">&quot; (eth)&quot;</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;&lt;/tspan&gt;&quot;</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span>
            <span class="token builtin">bytes</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>
                abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>
                    <span class="token string">'&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;606.2&quot; height=&quot;819.4&quot; viewBox=&quot;0 0 606.2 819.4&quot;&gt;&lt;defs&gt;&lt;style&gt;.a{fill:#fff;}.b{fill:none;stroke:#d9c8db;stroke-miterlimit:10;stroke-width:2px;}.c,.d,.e,.f,.g,.h,.i,.j,.k,.l,.m,.n,.o{isolation:isolate;}.c,.d,.e,.f,.g,.i,.j,.k{font-size:55px;}.c,.e{fill:#e96b5d;}.c,.d,.e,.f,.g,.k{font-family:LustDisplay-Didone, Lust Didone;}.d,.f{fill:#9b4a8d;}.e{letter-spacing:0.02em;}.f{letter-spacing:0.02em;}.g{fill:#9b4a8c;}.h{font-size:45px;fill:#0cb6ea;font-family:Lust-Italic, Lust;font-style:italic;}.i,.k{fill:#50ae58;}.i,.j{font-family:Lust-Regular, Lust;letter-spacing:0.05em;}.j{fill:#ef8916;}.l,.m{font-size:29.99px;}.l,.n{font-family:Arial-BoldMT, Arial;font-weight:700;}.m,.o{font-family:ArialMT, Arial; margin-left: auto; margin-right: auto; width: 40%;}.n{font-size:20px;}.o{font-size:18px;}&lt;/style&gt;&lt;/defs&gt;&lt;rect class=&quot;a&quot; width=&quot;606.2&quot; height=&quot;819.4&quot;/&gt;&lt;text class=&quot;n&quot;&gt;&lt;tspan class=&quot;n&quot; text-anchor=&quot;middle&quot; x=&quot;50%&quot; y=&quot;42%&quot;&gt;'</span><span class="token punctuation">,</span>
                    tokens<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>recipient<span class="token punctuation">,</span>
                    <span class="token string">'&lt;/tspan&gt;&lt;/text&gt;&lt;text transform=&quot;translate(75 352.85)&quot; font-size=&quot;18&quot; font-family=&quot;ArialMT, Arial&quot;&gt;&lt;tspan text-anchor=&quot;middle&quot; x=&quot;37.5%&quot; y=&quot;200&quot;&gt;'</span><span class="token punctuation">,</span>
                    tokens<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>timestamp<span class="token punctuation">,</span>
                    <span class="token string">&quot;&lt;/tspan&gt;&quot;</span><span class="token punctuation">,</span>
                    eth
                <span class="token punctuation">)</span><span class="token punctuation">,</span>
                abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>
                    <span class="token string">'&lt;tspan text-anchor=&quot;middle&quot; x=&quot;37.5%&quot; y=&quot;320&quot;&gt;0x'</span><span class="token punctuation">,</span>
                    contractAddressString<span class="token punctuation">,</span>
                    <span class="token string">&quot;&lt;/tspan&gt;&quot;</span><span class="token punctuation">,</span>
                    message<span class="token punctuation">,</span>
                    <span class="token string">'&lt;tspan text-anchor=&quot;middle&quot; x=&quot;37.5%&quot; y=&quot;220&quot;&gt;mint timestamp&lt;/tspan&gt;'</span><span class="token punctuation">,</span>
                    <span class="token string">'&lt;tspan text-anchor=&quot;middle&quot; x=&quot;37.5%&quot; y=&quot;340&quot;&gt;contract&lt;/tspan&gt;'</span><span class="token punctuation">,</span>
                    <span class="token string">'&lt;tspan text-anchor=&quot;middle&quot; x=&quot;37.5%&quot; y=&quot;280&quot;&gt;value&lt;/tspan&gt;&lt;tspan text-anchor=&quot;middle&quot; x=&quot;37.5%&quot; y=&quot;140&quot;&gt;&lt;/tspan&gt;&lt;/text&gt;'</span><span class="token punctuation">,</span>
                    <span class="token string">'&lt;rect class=&quot;b&quot; x=&quot;21.9&quot; y=&quot;169.5&quot; width=&quot;562.4&quot; height=&quot;562.4&quot;/&gt;&lt;g style=&quot;isolation:isolate&quot;&gt;&lt;path d=&quot;M46.66,98.93v-.28h4.89V60.71H46.66v-.28H65.91c12,0,18.42,3.19,18.42,11.17,0,9.4-11.77,11.27-19.85,11.27h-1.6V98.65h5.83v.28ZM62.88,82.6h1.6c5.83,0,7.75-3.47,7.75-11s-1.92-10.89-7.75-10.89h-1.6Z&quot; style=&quot;fill:#e96b5d&quot;/&gt;&lt;/g&gt;&lt;g style=&quot;isolation:isolate&quot;&gt;&lt;path d=&quot;M135,91.84c0,5.16-2.26,7.53-9.21,7.53-6.74,0-9.43-2.28-11.55-8.63C113,87,112.44,79.52,107.52,79.52h-1.6V98.65h5.28v.28H89.7v-.28h4.89V60.71H89.7v-.28H109c5.66,0,18.47.22,18.47,9.46,0,7.54-10.77,9.27-17.32,9.54v.09c10.75,0,13.94,3.52,16.58,9.15,3.33,7.12,4.13,8.17,5.53,8.17,2.2,0,2.47-3.35,2.47-5Zm-29-12.6h1.6c5.44,0,7.81-2.86,7.81-9.35,0-5.11-1.82-9.18-7.79-9.18h-1.62Z&quot; style=&quot;fill:#9b4a8d&quot;/&gt;&lt;/g&gt;&lt;g style=&quot;isolation:isolate&quot;&gt;&lt;path d=&quot;M178.65,79.68c0,12.54-8.85,19.69-19.71,19.69s-19.72-7.15-19.72-19.69S148.07,60,158.94,60,178.65,67.14,178.65,79.68Zm-11.8,0c0-8.41-.52-19.41-7.91-19.41S151,71.27,151,79.68s.52,19.41,7.92,19.41S166.85,88.1,166.85,79.68Z&quot; style=&quot;fill:#e96b5d&quot;/&gt;&lt;/g&gt;&lt;g style=&quot;isolation:isolate&quot;&gt;&lt;path d=&quot;M226.68,79.68c0,12.54-8.9,19.69-19.83,19.69S187,92.22,187,79.68,195.92,60,206.85,60,226.68,67.14,226.68,79.68Zm-11.87,0c0-8.41-.52-19.41-8-19.41s-8,11-8,19.41.52,19.41,8,19.41S214.81,88.1,214.81,79.68Z&quot; style=&quot;fill:#9b4a8d&quot;/&gt;&lt;/g&gt;&lt;g style=&quot;isolation:isolate&quot;&gt;&lt;path d=&quot;M236.69,98.93v-.28h4.89V60.71h-4.89v-.28h33.93L272,73.69h-.27l-.11-1c-.8-7.56-6.82-12-14.3-12h-4.4V79.13h.61c6.18,0,10.2-2.58,10.5-7.72l.05-1h.28l-.93,17.77h-.28l.05-1c.28-5.12-3.49-7.81-9.67-7.81h-.61V98.65h5.83v.28Z&quot; style=&quot;fill:#9b4a8c&quot;/&gt;&lt;/g&gt;&lt;g style=&quot;isolation:isolate&quot;&gt;&lt;path d=&quot;M307.71,87.38c0,7.47-6.75,14.17-14.76,14.17-6.43,0-10.89-4.27-10.89-10.21,0-7.7,6.62-14.18,14.72-14.18C303.26,77.16,307.71,81.44,307.71,87.38Zm-8.23-4.64c0-2.65-.5-5.22-2.75-5.22-5,0-6.43,13.86-6.43,18.54,0,2.66.49,5.13,2.7,5.13C298,101.19,299.48,88.05,299.48,82.74Z&quot; style=&quot;fill:#0cb6ea&quot;/&gt;&lt;/g&gt;&lt;g style=&quot;isolation:isolate&quot;&gt;&lt;path d=&quot;M300.13,105.46a4.61,4.61,0,0,1,4.68-4.77,3.93,3.93,0,0,1,4.09,4.18,3.26,3.26,0,0,0-2.7,3.29c0,1.08.45,1.93,1.71,1.93,2.12,0,4-2.34,4-5.76,0-2.07-.67-4.32-4-5.49l3.37-22H307.6l0-.36h3.65c.31-6.7,2.52-11.88,9.18-11.88,4.5,0,6.57,2.48,6.57,5.27a4.75,4.75,0,0,1-4.82,5c-2.2,0-4-1.44-4-4.27a3.09,3.09,0,0,0,2.88-3.2c0-1.35-.58-2.29-2.07-2.29-5.31,0-6.84,11.38,1.44,11.38h3.2l0,.36h-4.27L316,98.75c-.86,5.4-3.47,12-9.77,12C302.29,110.72,300.13,108.2,300.13,105.46Z&quot; style=&quot;fill:#0cb6ea&quot;/&gt;&lt;/g&gt;&lt;g style=&quot;isolation:isolate&quot;&gt;&lt;path d=&quot;M345.85,98.1l-4.07,1.16-.88-16h.44c.88,6.44,4.45,15.62,14.35,15.62,5,0,9-1.76,9-5.83,0-9.24-24-8.41-24-21.72C340.68,64,347.77,60,356.57,60a39.37,39.37,0,0,1,8.75,1.26l4.18-1.16.71,13.53h-.44c-.88-6.21-4.34-13.19-13.2-13.19-4.4,0-7.42,2.08-7.42,5.66,0,8.41,24,7.09,24,20.79,0,7.75-8.13,12.48-17.43,12.48A41.65,41.65,0,0,1,345.85,98.1Z&quot; style=&quot;fill:#50ae58&quot;/&gt;&lt;path d=&quot;M384.62,98.93v-.44c5.72,0,6.27-3,6.27-9.46V60.88c-8.91,0-12.87,5.33-13.8,13.63h-.44l1.48-14.07H415l1.48,14.07H416c-.93-8.3-4.89-13.63-13.8-13.63V89c0,6.44.55,9.46,6.27,9.46v.44Z&quot; style=&quot;fill:#50ae58&quot;/&gt;&lt;/g&gt;&lt;g style=&quot;isolation:isolate&quot;&gt;&lt;path d=&quot;M455.54,88.43c3.46,7.2,5.11,10.06,9.07,10.06v.44H442.18v-.44c5.22,0,4.18-4.18,1.48-9.95l-1.39-3H429.18c-4,8.38-2.59,12.92,3.43,12.92v.44H417.1v-.44c4,0,7.42-4.67,11.71-13.36l12.71-25.79ZM429.45,85H442l-6.11-13.08Z&quot; style=&quot;fill:#ef8916&quot;/&gt;&lt;path d=&quot;M504.71,87.66c4.29,9.51,5.5,10.39,8.14,10.11v.45a36.94,36.94,0,0,1-8.75,1.26c-6.76,0-9.4-2.58-11.43-8.74-1.76-5.34-3.25-11.44-6.77-11.44a4.07,4.07,0,0,0-1.81.46V89c0,6.44.49,9.46,4.56,9.46v.44H467.26v-.44c5.5,0,5.5-3,5.5-9.46V70.33c0-6.65,0-9.46-5.5-9.46v-.43h21.39v.43c-4.07,0-4.56,3-4.56,9.46V79.1l7-7.67c2.36-2.53,5.39-6.16,5.39-8.41,0-1.49-1-2.15-3.63-2.15v-.43h16.66v.43c-7,0-14.68,7.32-18,10.95l-6.48,7a18,18,0,0,1,8.24-2c5.56,0,8.19,3.3,11.44,10.84Z&quot; style=&quot;fill:#ef8916&quot;/&gt;&lt;/g&gt;&lt;g style=&quot;isolation:isolate&quot;&gt;&lt;path d=&quot;M552.2,73.69h-.28l-.11-1c-.8-7.56-6.82-12-14.3-12H532V79.13h.61c6.18,0,10.2-2.58,10.5-7.72l.06-1h.27l-.93,17.77h-.28l.06-1c.27-5.12-3.5-7.81-9.68-7.81H532V92c0,5.33.61,6.7,4.4,6.7,9.87,0,16-6.15,17.35-15l.2-1.24h.27l-2.64,16.5h-35.8v-.28h4.89V60.71h-4.89v-.27h35Z&quot; style=&quot;fill:#50ae58&quot;/&gt;&lt;/g&gt;&lt;text class=&quot;l&quot; transform=&quot;translate(235.15 265)&quot;&gt;vitalik.eth&lt;/text&gt; &lt;text class=&quot;m&quot; transform=&quot;translate(263.48 295)&quot;&gt;signer&lt;/text&gt; &lt;text class=&quot;m&quot; transform=&quot;translate(245.64 373)&quot;&gt;recipient&lt;/text&gt;&lt;/svg&gt;'</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 產生 SVG，以 base64 來編碼</span>
    <span class="token comment">/**
     * @notice Generate SVG, b64 encode it, construct an ERC721 token URI.
     */</span>
    <span class="token keyword">function</span> <span class="token function">constructTokenURI</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> id<span class="token punctuation">)</span>
        <span class="token keyword">private</span>
        <span class="token keyword">view</span>
        <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">string</span> <span class="token keyword">memory</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// prettier-ignore</span>

        <span class="token builtin">uint256</span> cID <span class="token operator">=</span> id <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment">// generateSVG 會將 cID 傳入，用來產生該 id 對應的 SVG</span>
        <span class="token builtin">string</span> <span class="token keyword">memory</span> pageSVG <span class="token operator">=</span> Base64<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token function">generateSVG</span><span class="token punctuation">(</span>cID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 建構出完整的 URI JSON</span>
        <span class="token keyword">return</span>
            <span class="token builtin">string</span><span class="token punctuation">(</span>
                abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;data:application/json;base64,&quot;</span><span class="token punctuation">,</span>
                    Base64<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>
                        <span class="token builtin">bytes</span><span class="token punctuation">(</span>
                            abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>
                                <span class="token string">'{&quot;signed_to&quot;:&quot;'</span><span class="token punctuation">,</span>
                                tokens<span class="token punctuation">[</span>cID<span class="token punctuation">]</span><span class="token punctuation">.</span>recipient<span class="token punctuation">,</span>
                                <span class="token string">'&quot;, &quot;external_url&quot;:&quot;'</span><span class="token punctuation">,</span>
                                <span class="token string">&quot;https://proofofstake.gitcoin.co/&quot;</span><span class="token punctuation">,</span>
                                <span class="token string">'&quot;, &quot;timestamp&quot;:&quot;'</span><span class="token punctuation">,</span>
                                tokens<span class="token punctuation">[</span>cID<span class="token punctuation">]</span><span class="token punctuation">.</span>timestamp<span class="token punctuation">,</span>
                                <span class="token string">'&quot;, &quot;pledge&quot;:&quot;'</span><span class="token punctuation">,</span>
                                udonationTotal<span class="token punctuation">[</span>tokens<span class="token punctuation">[</span>cID<span class="token punctuation">]</span><span class="token punctuation">.</span>rAddress<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                <span class="token string">'&quot;, &quot;message&quot;:&quot;'</span><span class="token punctuation">,</span>
                                tokens<span class="token punctuation">[</span>cID<span class="token punctuation">]</span><span class="token punctuation">.</span>writtenMsg<span class="token punctuation">,</span>
                                <span class="token string">'&quot;, &quot;image&quot;: &quot;'</span><span class="token punctuation">,</span>
                                <span class="token string">&quot;data:image/svg+xml;base64,&quot;</span><span class="token punctuation">,</span>
                                pageSVG<span class="token punctuation">,</span>
                                <span class="token string">'&quot;}'</span>
                            <span class="token punctuation">)</span>
                        <span class="token punctuation">)</span>
                    <span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 利用 token ID 建構出 NFT 的 URI 來建構完整的 URI json </span>
    <span class="token comment">/**
     * @notice Receives json from constructTokenURI
     */</span>
    <span class="token comment">// prettier-ignore</span>
    <span class="token keyword">function</span> <span class="token function">tokenURI</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> id<span class="token punctuation">)</span>
        <span class="token keyword">public</span>
        <span class="token keyword">view</span>
        override
        <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">string</span> <span class="token keyword">memory</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">_exists</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">revert</span> <span class="token function">DoesNotExist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">constructTokenURI</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 建構出本合約的 URI</span>
    <span class="token comment">// 請特別注意，常見的 NFT 在這邊都會給一個連結指向儲存一個 URI schema 的位置，如 ipfs / http</span>
    <span class="token comment">// 但本合約有趣的地方在於 NFT 本身是以 SVG 的方式文字儲存在區塊鏈上，因此他直接把 URI schema 存在裡面</span>
    <span class="token keyword">function</span> <span class="token function">contractURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">string</span> <span class="token keyword">memory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
            <span class="token builtin">string</span><span class="token punctuation">(</span>
                abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;data:application/json;base64,&quot;</span><span class="token punctuation">,</span>
                    Base64<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span> <span class="token comment">/* 將以下資料編碼成 base64 格式 */</span>
                        <span class="token builtin">bytes</span><span class="token punctuation">(</span>
                            abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>
                                <span class="token string">&quot;{&quot;</span><span class="token punctuation">,</span>
                                <span class="token string">'&quot;name&quot;:&quot;'</span><span class="token punctuation">,</span>
                                <span class="token string">&quot;Proof of Stake&quot;</span><span class="token punctuation">,</span>
                                <span class="token string">'&quot;,'</span>
                                <span class="token string">'&quot;description&quot;:&quot;'</span><span class="token punctuation">,</span>
                                <span class="token string">&quot;Vitalik is committed to supporting open-source public goods, he's releasing a book on September 13. We're pre-gaming by raising funds for public goods with a truly unique NFT, where Vitalik signs a message directly on your token. This token is then inserted into your digital copy upon the books release!&quot;</span><span class="token punctuation">,</span>
                                <span class="token string">'&quot;,'</span>
                                <span class="token string">'&quot;image_data&quot;:&quot;'</span><span class="token punctuation">,</span>
                                <span class="token comment">// Yeah, looks like CORS may not be letting this resolve, fix l8r</span>
                                <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
                                <span class="token string">'&quot;,'</span>
                                <span class="token string">'&quot;external_link&quot;:&quot;'</span><span class="token punctuation">,</span>
                                <span class="token string">&quot;https://proofofstake.gitcoin.co/&quot;</span><span class="token punctuation">,</span>
                                <span class="token string">'&quot;,'</span>
                                <span class="token string">'&quot;seller_fee_basis_points&quot;:&quot;'</span><span class="token punctuation">,</span>
                                <span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span>
                                <span class="token string">'&quot;,'</span>
                                <span class="token string">'&quot;fee_recipient&quot;:&quot;'</span><span class="token punctuation">,</span>
                                <span class="token string">&quot;0x00&quot;</span><span class="token punctuation">,</span>
                                <span class="token string">'&quot;}'</span>
                            <span class="token punctuation">)</span>
                        <span class="token punctuation">)</span>
                    <span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*///////////////////////////////////////////////////////////////
                             SIG LOGIC
    //////////////////////////////////////////////////////////////*/</span>

    <span class="token comment">/**
     * @notice https://eips.ethereum.org/EIPS/eip-712
     */</span>
    <span class="token keyword">function</span> <span class="token function">DOMAIN_SEPARATOR</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> virtual <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
            block<span class="token punctuation">.</span>chainid <span class="token operator">==</span> INITIAL_CHAIN_ID
                <span class="token operator">?</span> INITIAL_DOMAIN_SEPARATOR
                <span class="token punctuation">:</span> <span class="token function">computeDomainSeparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">computeDomainSeparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">view</span> virtual <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
            <span class="token function">keccak256</span><span class="token punctuation">(</span>
                abi<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>
                    <span class="token function">keccak256</span><span class="token punctuation">(</span>
                        <span class="token string">&quot;EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)&quot;</span>
                    <span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">keccak256</span><span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token string">&quot;ProofOfStake_Pages&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 參數： name</span>
                    <span class="token function">keccak256</span><span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 參數： version</span>
                    block<span class="token punctuation">.</span>chainid<span class="token punctuation">,</span> <span class="token comment">// 參數： chainId</span>
                    <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token comment">// 參數： verifyingContract</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/hydai/solidity.tw/edit/master/ethereum-101/29-實例解析Proof-of-Stake.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2024/12/5 上午5:58:25</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/ethereum-101/28-實例解析Proof-of-Stake.html" class="prev">
        實例解析 - Proof of Stake 書籍的捐款合約 Part 6
      </a></span> <span class="next"><a href="/ethereum-101/30-結語.html">
        結語
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.4cca3437.js" defer></script><script src="/assets/js/2.ce7b5ffa.js" defer></script><script src="/assets/js/1.843ff0e7.js" defer></script><script src="/assets/js/51.a77781e8.js" defer></script>
  </body>
</html>
