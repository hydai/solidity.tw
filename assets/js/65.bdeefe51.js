(window.webpackJsonp=window.webpackJsonp||[]).push([[65],{386:function(_,v,a){"use strict";a.r(v);var t=a(17),n=Object(t.a)({},(function(){var _=this,v=_._self._c;return v("ContentSlotsDistributor",{attrs:{"slot-key":_.$parent.slotKey}},[v("h1",{attrs:{id:"eip-7698-eof-部署交易"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#eip-7698-eof-部署交易"}},[_._v("#")]),_._v(" EIP-7698: EOF - 部署交易")]),_._v(" "),v("h2",{attrs:{id:"注意事項"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#注意事項"}},[_._v("#")]),_._v(" 注意事項")]),_._v(" "),v("p",[_._v("本文並沒有經過作者外的其他審查者審核，因此若內容有誤，請到 issue 區提出問題，我會儘速修改，謝謝。")]),_._v(" "),v("h2",{attrs:{id:"摘要"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#摘要"}},[_._v("#")]),_._v(" 摘要")]),_._v(" "),v("p",[_._v("部署交易（也就是「to」欄位為空的交易）可以用來部署 EOF 智慧合約，方式是在交易的 "),v("code",[_._v("data")]),_._v(" 欄位中提供 EOF 初始容器，以及用於執行初始容器的 "),v("code",[_._v("calldata")]),_._v("（並將兩者串接起來）。這種初始容器的執行流程與 "),v("code",[_._v("EOFCREATE")]),_._v(" 指令的執行邏輯類似，最終會以 "),v("code",[_._v("RETURNCODE")]),_._v(" 指令結束。新帳戶地址的計算則是根據發送者地址與其 Nonce 值。")]),_._v(" "),v("h2",{attrs:{id:"動機"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#動機"}},[_._v("#")]),_._v(" 動機")]),_._v(" "),v("p",[_._v("部署交易是除了傳統 EVM 的部署指令之外，用來部署新程式碼的三種方式之一。由於傳統的 "),v("code",[_._v("CREATE")]),_._v(" 和 "),v("code",[_._v("CREATE2")]),_._v(" 指令不支援部署 EOF 格式，因此部署交易是目前部署 EOF 程式碼上鏈，除了 "),v("code",[_._v("EOFCREATE")]),_._v(" (參考 EIP-7620) 以外的唯一方式。")]),_._v(" "),v("p",[_._v("為了不破壞現有工具鏈的部署流程，如何傳遞建構函式參數的機制刻意與傳統部署方式相同，即把參數與初始容器串接起來即可，使得現有的部署工具無需任何修改也能無痛支援 EOF。")]),_._v(" "),v("h2",{attrs:{id:"規格說明"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#規格說明"}},[_._v("#")]),_._v(" 規格說明")]),_._v(" "),v("p",[_._v("除非另有說明，EOF 合約的部署規則應與傳統部署交易相同或類似，包括但不限於：")]),_._v(" "),v("ul",[v("li",[_._v("關於 "),v("code",[_._v("accessed_addresses")]),_._v(" 與地址衝突的處理（請參考 EIP-684 與 EIP-2929）")]),_._v(" "),v("li",[_._v("為初始程式碼部署的 EVM 執行環境（例如記憶體、帳戶環境）")]),_._v(" "),v("li",[_._v("新合約帳戶的 Nonce 增加（請參考 EIP-161）")]),_._v(" "),v("li",[_._v("部署時轉帳的餘額驗證與轉移邏輯")])]),_._v(" "),v("h3",{attrs:{id:"常數定義"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#常數定義"}},[_._v("#")]),_._v(" 常數定義")]),_._v(" "),v("table",[v("thead",[v("tr",[v("th",[_._v("常數名稱")]),_._v(" "),v("th",[_._v("值")])])]),_._v(" "),v("tbody",[v("tr",[v("td",[v("code",[_._v("EOF_MAGIC")])]),_._v(" "),v("td",[v("code",[_._v("0xEF00")]),_._v("（定義於 EIP-3540）")])]),_._v(" "),v("tr",[v("td",[v("code",[_._v("MAX_CODE_SIZE")])]),_._v(" "),v("td",[v("code",[_._v("24576")]),_._v("（定義於 EIP-170）")])])])]),_._v(" "),v("p",[_._v("當部署交易的 "),v("code",[_._v("data")]),_._v(" 以 "),v("code",[_._v("EOF_MAGIC")]),_._v(" ("),v("code",[_._v("0xEF00")]),_._v(") 開頭時，表示該 "),v("code",[_._v("data")]),_._v(" 為 EOF 初始容器與 "),v("code",[_._v("calldata")]),_._v(" 的串接。其處理步驟如下：")]),_._v(" "),v("ol",[v("li",[_._v("根據 EIP-3860，對整個 "),v("code",[_._v("data")]),_._v(" 計算部署交易的固有 Gas 成本。")]),_._v(" "),v("li",[_._v("將 "),v("code",[_._v("data")]),_._v(" 分割為初始容器與 "),v("code",[_._v("calldata")]),_._v("：\n"),v("ul",[v("li",[_._v("解析 EOF 標頭檔")]),_._v(" "),v("li",[_._v("累加所有區段大小與標頭檔大小，即為完整初始容器的長度")])])]),_._v(" "),v("li",[_._v("驗證初始容器及其遞迴子容器，並確認：\n"),v("ul",[v("li",[v("code",[_._v("data_size")]),_._v(" 欄位值與實際資料區段大小一致")]),_._v(" "),v("li",[_._v("不包含 "),v("code",[_._v("RETURN")]),_._v(" 或 "),v("code",[_._v("STOP")]),_._v(" 指令")])])]),_._v(" "),v("li",[_._v("若標頭檔解析或驗證失敗，交易仍有效但會執行失敗。只扣除固有部署交易成本，不執行初始容器。")]),_._v(" "),v("li",[_._v("剩餘的 "),v("code",[_._v("calldata")]),_._v(" 作為執行初始容器時的輸入。")]),_._v(" "),v("li",[_._v("執行流程如下：\n"),v("ul",[v("li",[_._v("使用 "),v("code",[_._v("keccak256(sender || sender_nonce)[12:]")]),_._v(" 計算新帳戶地址")]),_._v(" "),v("li",[_._v("執行成功會以 "),v("code",[_._v("RETURNCODE{deploy_container_index}(aux_data_offset, aux_data_size)")]),_._v(" 結尾\n"),v("ul",[v("li",[_._v("從指定容器索引載入部署容器")]),_._v(" "),v("li",[_._v("串接其資料區段與記憶體中 "),v("code",[_._v("(aux_data_offset, aux_data_offset + aux_data_size)")]),_._v(" 片段，並更新標頭檔資料大小")]),_._v(" "),v("li",[_._v("若更新後大小 > "),v("code",[_._v("MAX_CODE_SIZE")]),_._v("，則異常終止")]),_._v(" "),v("li",[_._v("成功部署後，"),v("code",[_._v("state[new_address].code")]),_._v(" 即為更新後的部署容器")]),_._v(" "),v("li",[_._v("此時不適用 EIP-3541 對 "),v("code",[_._v("0xEF")]),_._v(" 開頭程式碼的禁止規定，畢竟我們確實在部署一個 EOFv1 合約")])])])])]),_._v(" "),v("li",[_._v("最後會額外扣除 "),v("code",[_._v("200 * deployed_code_size")]),_._v(" 的 Gas")])]),_._v(" "),v("h2",{attrs:{id:"簡單範例"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#簡單範例"}},[_._v("#")]),_._v(" 簡單範例")]),_._v(" "),v("p",[_._v("以下為一個簡單計數器合約的部署範例，初始值會透過建構函式設定：")]),_._v(" "),v("div",{staticClass:"language-txt extra-class"},[v("pre",{pre:!0,attrs:{class:"language-txt"}},[v("code",[_._v('// 計數器合約 (counter.eof)\n// 功能：儲存數字，可增加或取得\n// 建構函式參數：初始值\n\n部署交易如下：\n\n{\n  "from": "0x123...789",\n  "to": "",\n  "value": 0,\n  "data": "0xEF00...000000000000000000000000000000000000000000000000000000000000000A"\n}\n\n流程與 ASCII 示意圖\n\n+-------------------------------+\n|        部署交易開始           |\n+-------------------------------+\n             |\n             v\n+-------------------------------+\n| 檢查交易.data 是否以 0xEF00 開頭 |\n+-------------------------------+\n             |\n             v\n+-------------------------------+\n|     分割 data 為兩部分：      |\n| 1. EOF 初始容器               |\n| 2. 建構函式參數（calldata）   |\n+-------------------------------+\n             |\n             v\n+-------------------------------+\n| 驗證初始容器（標頭、結構等）  |\n+-------------------------------+\n             |\n             v\n+-------------------------------+\n| keccak256(sender || Nonce)[12:]|\n| → 計算新帳戶地址              |\n+-------------------------------+\n             |\n             v\n+-------------------------------+\n| 執行容器並處理 calldata       |\n+-------------------------------+\n             |\n             v\n+-------------------------------+\n| 執行 RETURNCODE 指令          |\n| → 回傳部署容器與附加資料     |\n+-------------------------------+\n             |\n             v\n+-------------------------------+\n| 儲存至區塊鏈的最終部署程式碼 |\n+-------------------------------+\n')])])]),v("h2",{attrs:{id:"資料結構圖解"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#資料結構圖解"}},[_._v("#")]),_._v(" 資料結構圖解")]),_._v(" "),v("div",{staticClass:"language-txt extra-class"},[v("pre",{pre:!0,attrs:{class:"language-txt"}},[v("code",[_._v("交易.data 結構：\n+-------------------------+------------------+\n| EOF 初始容器            | 建構參數 (10)    |\n| 0xEF00...               | 0x...0000000A    |\n+-------------------------+------------------+\n\nEOF 初始容器結構：\n+------------+----------+-------------+------------+-------------+\n| EOF_MAGIC  | 版本     | 區段標頭    | 程式碼區段 | 資料區段    |\n| 0xEF00     | 0x01     | ...         | ...        | ...         |\n+------------+----------+-------------+------------+-------------+\n\n記憶體內容（執行時）：\n+------------+------------+------------+----------------+\n| Offset 0   | ...        | aux_offset | ...            |\n| 運算資料   | ...        | calldata   | ...            |\n+------------+------------+------------+----------------+\n                            ↓\n                        初始化使用\n                            ↓\n最終部署程式碼：\n+------------+----------+-------------+------------+------------------+\n| EOF_MAGIC  | 版本     | 區段標頭    | 程式碼區段 | 資料區段 (含初始值) |\n+------------+----------+-------------+------------+------------------+\n")])])])])}),[],!1,null,null,null);v.default=n.exports}}]);