(window.webpackJsonp=window.webpackJsonp||[]).push([[64],{385:function(v,_,a){"use strict";a.r(_);var t=a(17),e=Object(t.a)({},(function(){var v=this,_=v._self._c;return _("ContentSlotsDistributor",{attrs:{"slot-key":v.$parent.slotKey}},[_("h1",{attrs:{id:"eip-7620-eof-合約部署新方式"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#eip-7620-eof-合約部署新方式"}},[v._v("#")]),v._v(" EIP-7620：EOF 合約部署新方式")]),v._v(" "),_("h2",{attrs:{id:"注意事項"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#注意事項"}},[v._v("#")]),v._v(" 注意事項")]),v._v(" "),_("p",[v._v("本文並沒有經過作者外的其他審查者審核，因此若內容有誤，請到 issue 區提出問題，我會儘速修改，謝謝。")]),v._v(" "),_("h2",{attrs:{id:"簡介"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#簡介"}},[v._v("#")]),v._v(" 簡介")]),v._v(" "),_("p",[v._v("在過去我們用 "),_("code",[v._v("CREATE")]),v._v(" 或 "),_("code",[v._v("CREATE2")]),v._v(" 指令來部署新合約，但在 EOF 格式出現後，由於合約結構的改變，這些舊指令與模式就不再適用了。因此，我們迫切需要定義一套新的機制來處理 EOF 格式的合約部署。")]),v._v(" "),_("p",[v._v("本 EIP 引入了兩個新指令：")]),v._v(" "),_("ul",[_("li",[_("code",[v._v("EOFCREATE")]),v._v("：用來建立新的 EOF 合約")]),v._v(" "),_("li",[_("code",[v._v("RETURNCODE")]),v._v("：用來指定要實際部署的程式碼內容")])]),v._v(" "),_("h2",{attrs:{id:"新的合約部署流程"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#新的合約部署流程"}},[v._v("#")]),v._v(" 新的合約部署流程")]),v._v(" "),_("div",{staticClass:"language-txt extra-class"},[_("pre",{pre:!0,attrs:{class:"language-txt"}},[_("code",[v._v("+—————––+      +——————+      +——————+\n| 工廠合約內有多個 |      | 執行 EOFCREATE   |      | 執行成功後透過   |\n| 子容器（合約程式碼）|  ->  | 選擇其中一個子容器 |  ->  | RETURNCODE 指定 |\n|                    |      | 作為初始程式碼     |      | 要部署的容器     |\n+—————––+      +——————+      +——————+\n")])])]),_("h2",{attrs:{id:"eofcreate-範例"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#eofcreate-範例"}},[v._v("#")]),v._v(" EOFCREATE 範例")]),v._v(" "),_("p",[v._v("假設我們有一個工廠合約，想用它來建立一個簡單的 ERC20 代幣合約：")]),v._v(" "),_("div",{staticClass:"language-txt extra-class"},[_("pre",{pre:!0,attrs:{class:"language-txt"}},[_("code",[v._v("+———————————————————+\n| 工廠合約（Factory Contract）                           |\n|                                                         |\n| +———————+    +–––––––––––+     |\n| | 子容器 #0（主程式碼）|    | 子容器 #1（初始程式碼）|     |\n| |                     |    |                      |     |\n| | EOFCREATE{1}        |    | 讀取輸入參數         |     |\n| |（選擇子容器 #1 作為 |    | 設定代幣名稱和符號    |     |\n| | 初始程式碼）        |    | RETURNCODE{2}        |     |\n| +———————+    +–––––––––––+     |\n|                                                         |\n| +————————————————+      |\n| | 子容器 #2（ERC20 合約程式碼）                 |      |\n| |                                                |      |\n| | 名稱：<待填入>                                 |      |\n| | 符號：<待填入>                                 |      |\n| | transfer()                                     |      |\n| | balanceOf()                                    |      |\n| | … 其他 ERC20 功能 …                        |      |\n| +————————————————+      |\n+———————————————————+\n")])])]),_("p",[v._v("使用流程範例：")]),v._v(" "),_("ol",[_("li",[v._v("使用者呼叫工廠合約的部署函式，並傳入所需的參數，比如：代幣名稱、代幣符號、salt 值等")]),v._v(" "),_("li",[v._v("工廠合約執行 EOFCREATE{1} 指令，選擇子容器 #1 為初始程式碼")]),v._v(" "),_("li",[v._v("初始程式碼執行時讀取參數，設定代幣名稱與符號")]),v._v(" "),_("li",[v._v("初始程式碼最後執行 RETURNCODE{2}，選擇子容器 #2 作為實際部署合約")]),v._v(" "),_("li",[v._v("新的 ERC20 合約會被部署到一個新地址："),_("code",[v._v("keccak256(0xff || 工廠合約地址 || salt)[12:]")])])]),v._v(" "),_("h3",{attrs:{id:"執行流程"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#執行流程"}},[v._v("#")]),v._v(" 執行流程")]),v._v(" "),_("div",{staticClass:"language-txt extra-class"},[_("pre",{pre:!0,attrs:{class:"language-txt"}},[_("code",[v._v("+—————+     +——————+     +——————+     +––––––––+\n| 使用者呼叫工廠 |     | 工廠合約執行     |     | 初始程式碼執行   |     | 部署 ERC20 合約 |\n| 合約並傳入參數 | –> | EOFCREATE{1}     | –> | 並使用           | –> | 到新地址，      |\n|               |     | 選擇子容器 #1    |     | RETURNCODE{2}    |     | 參數已設定完成  |\n+—————+     +——————+     +——————+     +––––––––+\n")])])]),_("h2",{attrs:{id:"指令說明"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#指令說明"}},[v._v("#")]),v._v(" 指令說明")]),v._v(" "),_("h3",{attrs:{id:"eofcreate-0xec"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#eofcreate-0xec"}},[v._v("#")]),v._v(" "),_("code",[v._v("EOFCREATE")]),v._v("（0xec）")]),v._v(" "),_("p",[v._v("這個指令是新版專屬 EOF 的合約部署方式，概念上更類似於 "),_("code",[v._v("CREATE2")]),v._v("。")]),v._v(" "),_("p",[v._v("使用步驟：")]),v._v(" "),_("ol",[_("li",[v._v("從堆疊中讀取 "),_("code",[v._v("salt")]),v._v("、輸入資料位置與大小、部署時的初始餘額")]),v._v(" "),_("li",[v._v("選定工廠合約內某個子容器作為初始程式碼")]),v._v(" "),_("li",[v._v("初始程式碼執行後，透過 "),_("code",[v._v("RETURNCODE")]),v._v(" 指定要實際部署的合約")]),v._v(" "),_("li",[v._v("最後的合約地址是："),_("code",[v._v("keccak256(0xff || 工廠合約地址 || salt)[12:]")])])]),v._v(" "),_("h3",{attrs:{id:"returncode-0xee"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#returncode-0xee"}},[v._v("#")]),v._v(" "),_("code",[v._v("RETURNCODE")]),v._v("（0xee）")]),v._v(" "),_("p",[v._v("這個指令是用來指定部署時應使用哪個容器作為最終合約程式碼。")]),v._v(" "),_("p",[v._v("使用方式：")]),v._v(" "),_("ol",[_("li",[v._v("從堆疊讀取額外資料位置與大小")]),v._v(" "),_("li",[v._v("選擇一個容器作為部署對象")]),v._v(" "),_("li",[v._v("將額外資料附加在容器的資料區段中")])]),v._v(" "),_("h2",{attrs:{id:"資料區段的生命週期"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#資料區段的生命週期"}},[v._v("#")]),v._v(" 資料區段的生命週期")]),v._v(" "),_("p",[v._v("合約在部署前後，資料區段會發生變化：")]),v._v(" "),_("div",{staticClass:"language-txt extra-class"},[_("pre",{pre:!0,attrs:{class:"language-txt"}},[_("code",[v._v("部署前:\n+———————––+\n| 預部署資料區段          |\n+———————––+\n|<–– 預部署資料大小 —>|\n\n部署後:\n+———————––+–––––+———––+\n| 預部署資料區段          | 靜態額外 | 動態額外    |\n|                         | 資料     | 資料        |\n+———————––+–––––+———––+\n|<–– 預部署資料大小 —>|                       |\n|                         |<–– 額外資料 —––>|\n|<––––––– 最終資料大小 ——————>|\n")])])]),_("h2",{attrs:{id:"驗證規則"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#驗證規則"}},[v._v("#")]),v._v(" 驗證規則")]),v._v(" "),_("p",[v._v("為了確保部署安全與正確性，必須符合以下驗證規則：")]),v._v(" "),_("ol",[_("li",[_("code",[v._v("EOFCREATE")]),v._v(" 的 "),_("code",[v._v("initcontainer_index")]),v._v(" 必須小於容器總數")]),v._v(" "),_("li",[_("code",[v._v("EOFCREATE")]),v._v(" 指向的子容器資料大小必須正確")]),v._v(" "),_("li",[v._v("初始程式碼不能包含 "),_("code",[v._v("RETURN")]),v._v(" 或 "),_("code",[v._v("STOP")])]),v._v(" "),_("li",[_("code",[v._v("RETURNCODE")]),v._v(" 的目標容器索引必須合法")]),v._v(" "),_("li",[v._v("被部署的容器不得含有 "),_("code",[v._v("RETURNCODE")])]),v._v(" "),_("li",[v._v("容器不得同時含有 "),_("code",[v._v("RETURNCODE")]),v._v(" 與 "),_("code",[v._v("RETURN")]),v._v("/"),_("code",[v._v("STOP")])]),v._v(" "),_("li",[v._v("子容器必須在父容器中有被正確引用")]),v._v(" "),_("li",[v._v("同一容器不得同時被 "),_("code",[v._v("EOFCREATE")]),v._v(" 和 "),_("code",[v._v("RETURNCODE")]),v._v(" 引用")]),v._v(" "),_("li",[v._v("跳躍指令不得跳到 "),_("code",[v._v("EOFCREATE")]),v._v(" 或 "),_("code",[v._v("RETURNCODE")]),v._v(" 之後的位置")])]),v._v(" "),_("h2",{attrs:{id:"結語"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#結語"}},[v._v("#")]),v._v(" 結語")]),v._v(" "),_("p",[v._v("本 EIP 讓我們可以在以太坊的新 EOF 格式下，更安全、更清楚地部署智慧合約。透過 "),_("code",[v._v("EOFCREATE")]),v._v(" 和 "),_("code",[v._v("RETURNCODE")]),v._v(" 的組合，我們能動態地創建像 ERC20 這樣的合約，也可以根據輸入參數自訂內容，保有合約部署的彈性。如同原本部署舊有合約的方式一樣。")])])}),[],!1,null,null,null);_.default=e.exports}}]);