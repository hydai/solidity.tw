(window.webpackJsonp=window.webpackJsonp||[]).push([[56],{375:function(v,_,t){"use strict";t.r(_);var d=t(17),e=Object(d.a)({},(function(){var v=this,_=v._self._c;return _("ContentSlotsDistributor",{attrs:{"slot-key":v.$parent.slotKey}},[_("h1",{attrs:{id:"eip-3540-電腦程式的新衣服-evm-物件格式-eof"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#eip-3540-電腦程式的新衣服-evm-物件格式-eof"}},[v._v("#")]),v._v(" EIP-3540 電腦程式的新衣服 - EVM 物件格式 (EOF)")]),v._v(" "),_("h2",{attrs:{id:"注意事項"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#注意事項"}},[v._v("#")]),v._v(" 注意事項")]),v._v(" "),_("p",[v._v("本文並沒有經過作者外的其他審查者審核，因此若內容有誤，請到 issue 區提出問題，我會儘速修改，謝謝。")]),v._v(" "),_("h2",{attrs:{id:"簡單說明"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#簡單說明"}},[v._v("#")]),v._v(" 簡單說明")]),v._v(" "),_("p",[v._v("我們要給電腦程式一種新的「包裝方式」，就像是給程式穿上一件新衣服。這種新包裝讓EVM 可以快速辨識程式的不同部分，比如哪部分是實際要執行的指令，哪部分只是資料。而且這件新衣服還可以隨時升級，加入更多功能！")]),v._v(" "),_("p",[v._v("這種新包裝的程式長得像這樣：")]),v._v(" "),_("div",{staticClass:"language-txt extra-class"},[_("pre",{pre:!0,attrs:{class:"language-txt"}},[_("code",[v._v("魔法標記, 版本號, (區塊類型, 區塊大小)+, 0, <區塊內容>\n")])])]),_("h2",{attrs:{id:"為什麼需要這個"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#為什麼需要這個"}},[v._v("#")]),v._v(" 為什麼需要這個？")]),v._v(" "),_("p",[v._v("現在的以太坊區塊鏈上，程式沒有固定的結構。導致 EVM 需要每次在執行期間都需要重新檢查整個程式，這樣會額外消耗執行時間與資源。")]),v._v(" "),_("p",[v._v("有了這個新包裝，電腦只需要在程式上傳到區塊鏈前檢查一次。這樣做有幾個好處：")]),v._v(" "),_("ol",[_("li",[v._v("可以區分「指令」和「資料」，就像分清楚「食譜步驟」和「食材」一樣")]),v._v(" "),_("li",[v._v("引入版本的概念，可以更容易地加入新功能或移除舊功能，不像以前需要透過硬分岔的區塊高度來控制行為")]),v._v(" "),_("li",[v._v("讓程式更安全，因為電腦可以事先確認程式是否正確")])]),v._v(" "),_("h2",{attrs:{id:"詳細規格"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#詳細規格"}},[v._v("#")]),v._v(" 詳細規格")]),v._v(" "),_("p",[v._v("新的格式用特殊的開頭標記（魔法標記）來識別。這個標記是 "),_("code",[v._v("0xEF00")]),v._v("，這有點像是一個特殊印章，說明「這是一個使用 EOF 格式的程式碼」。")]),v._v(" "),_("h3",{attrs:{id:"容器規格"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#容器規格"}},[v._v("#")]),v._v(" 容器規格")]),v._v(" "),_("p",[v._v("這個新包裝（我們稱為 EOF 容器）包含：")]),v._v(" "),_("p",[v._v("| 說明 | 長度 | 值 | |\n|-------------|----------|------------|\n| 魔法標記 | 2位元組 | 0xEF00 |\n| 版本號 | 1位元組 | 0x01–0xFF |")]),v._v(" "),_("p",[v._v("EOF 容器的開頭後面跟著至少一個區塊標頭。每個區塊標頭包含兩個欄位：")]),v._v(" "),_("ol",[_("li",[_("code",[v._v("區塊類型")])]),v._v(" "),_("li",[_("code",[v._v("區塊大小")]),v._v("或"),_("code",[v._v("區塊大小列表")]),v._v("，取決於該區塊的類型。當區塊類型可以是多個且重複時，"),_("code",[v._v("區塊大小列表")]),v._v("會依序列出每個區塊的大小，其長度與該區塊類型的數量相同。")])]),v._v(" "),_("table",[_("thead",[_("tr",[_("th",[v._v("說明")]),v._v(" "),_("th",[v._v("長度")]),v._v(" "),_("th",[v._v("值")]),v._v(" "),_("th")])]),v._v(" "),_("tbody",[_("tr",[_("td",[v._v("區塊類型")]),v._v(" "),_("td",[v._v("1位元組")]),v._v(" "),_("td",[v._v("0x01–0xFF")]),v._v(" "),_("td",[_("code",[v._v("uint8")])])]),v._v(" "),_("tr",[_("td",[v._v("區塊大小")]),v._v(" "),_("td",[v._v("2位元組")]),v._v(" "),_("td",[v._v("0x0000–0xFFFF")]),v._v(" "),_("td",[_("code",[v._v("uint16")])])]),v._v(" "),_("tr",[_("td",[v._v("區塊大小列表")]),v._v(" "),_("td",[v._v("動態")]),v._v(" "),_("td",[v._v("n/a")]),v._v(" "),_("td",[_("code",[v._v("uint16, uint16+")])])])])]),v._v(" "),_("p",[v._v("區塊標頭列表以"),_("em",[v._v("區塊標頭終止位元組")]),v._v(" "),_("code",[v._v("0x00")]),v._v(" 結束。區塊內容主體緊接在其後面。")]),v._v(" "),_("h4",{attrs:{id:"容器驗證規則"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#容器驗證規則"}},[v._v("#")]),v._v(" 容器驗證規則")]),v._v(" "),_("ol",[_("li",[_("code",[v._v("版本號")]),v._v(" 不能為 "),_("code",[v._v("0")]),v._v("。")]),v._v(" "),_("li",[_("code",[v._v("區塊類型")]),v._v(" 不能為 "),_("code",[v._v("0")]),v._v("。數值 "),_("code",[v._v("0")]),v._v(" 是為"),_("em",[v._v("區塊標頭終止位元組")]),v._v("保留的。")]),v._v(" "),_("li",[v._v("必須至少有一個區塊（因此至少有一個區塊標頭）。")]),v._v(" "),_("li",[v._v("區塊外不能有多餘的位元組。這包括最後一個區塊後多出來的尾端資料。")])]),v._v(" "),_("h3",{attrs:{id:"eof-第一版"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#eof-第一版"}},[v._v("#")]),v._v(" EOF 第一版")]),v._v(" "),_("p",[v._v("EOF 第一版由數個 EIP 組成，包括本 EIP。由於細節都被詳細定義在各自的 EIP 中，因此本規範中只是簡要討論。要理解 EOF 的完整範圍，請深入檢查對應的 EIP。")]),v._v(" "),_("h4",{attrs:{id:"容器"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#容器"}},[v._v("#")]),v._v(" 容器")]),v._v(" "),_("p",[v._v("EOF 第一版容器由 "),_("code",[v._v("標頭")]),v._v(" 和 "),_("code",[v._v("主體")]),v._v(" 組成。")]),v._v(" "),_("div",{staticClass:"language-txt extra-class"},[_("pre",{pre:!0,attrs:{class:"language-txt"}},[_("code",[v._v("容器 := 標頭, 主體\n標頭 := \n    魔法標記, 版本號碼, \n    類型區塊標記, 類型區塊大小, \n    程式區塊標記, 程式區塊數量, 程式區塊大小+,\n    [容器區塊標記, 容器區塊數量, 容器區塊大小+,]\n    資料區塊標記, 資料區塊大小,\n    終止符號\n主體 := 類型區塊, 程式區塊+, 容器區塊*, 資料區塊\n類型區塊 := (輸入, 輸出, 最大堆疊增加)+\n")])])]),_("p",[_("em",[v._v("注意："),_("code",[v._v(",")]),v._v(" 是連接運算符，"),_("code",[v._v("+")]),v._v(" 應解釋為「一個或更多」前一項，"),_("code",[v._v("*")]),v._v(" 應解釋為「零個或更多」前一項，"),_("code",[v._v("[物件]")]),v._v(" 應解釋為可選物件。")])]),v._v(" "),_("h4",{attrs:{id:"標頭"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#標頭"}},[v._v("#")]),v._v(" 標頭")]),v._v(" "),_("table",[_("thead",[_("tr",[_("th",[v._v("名稱")]),v._v(" "),_("th",[v._v("長度")]),v._v(" "),_("th",[v._v("值")]),v._v(" "),_("th",[v._v("說明")])])]),v._v(" "),_("tbody",[_("tr",[_("td",[v._v("魔法標記")]),v._v(" "),_("td",[v._v("2 位元組")]),v._v(" "),_("td",[v._v("0xEF00")]),v._v(" "),_("td")]),v._v(" "),_("tr",[_("td",[v._v("版本號")]),v._v(" "),_("td",[v._v("1 位元組")]),v._v(" "),_("td",[v._v("0x01")]),v._v(" "),_("td",[v._v("EOF 版本")])]),v._v(" "),_("tr",[_("td",[v._v("類型區塊標記")]),v._v(" "),_("td",[v._v("1 位元組")]),v._v(" "),_("td",[v._v("0x01")]),v._v(" "),_("td",[v._v("類型區塊的標記")])]),v._v(" "),_("tr",[_("td",[v._v("類型區塊大小")]),v._v(" "),_("td",[v._v("2 位元組")]),v._v(" "),_("td",[v._v("0x0004-0x1000")]),v._v(" "),_("td",[v._v("16位無符號(unsigned)大端(big-endian)整數，表示類型區塊內容的長度，每個程式區塊4位元組")])]),v._v(" "),_("tr",[_("td",[v._v("程式區塊標記")]),v._v(" "),_("td",[v._v("1 位元組")]),v._v(" "),_("td",[v._v("0x02")]),v._v(" "),_("td",[v._v("程式區塊大小區塊的標記")])]),v._v(" "),_("tr",[_("td",[v._v("程式區塊數量")]),v._v(" "),_("td",[v._v("2 位元組")]),v._v(" "),_("td",[v._v("0x0001-0x0400")]),v._v(" "),_("td",[v._v("16位無符號大端整數，表示程式區塊的數量")])]),v._v(" "),_("tr",[_("td",[v._v("程式區塊大小")]),v._v(" "),_("td",[v._v("2 位元組")]),v._v(" "),_("td",[v._v("0x0001-0xFFFF")]),v._v(" "),_("td",[v._v("16位無符號大端整數，表示程式區塊內容的長度")])]),v._v(" "),_("tr",[_("td",[v._v("容器區塊標記")]),v._v(" "),_("td",[v._v("1 位元組")]),v._v(" "),_("td",[v._v("0x03")]),v._v(" "),_("td",[v._v("容器區塊大小區塊的標記")])]),v._v(" "),_("tr",[_("td",[v._v("容器區塊數量")]),v._v(" "),_("td",[v._v("2 位元組")]),v._v(" "),_("td",[v._v("0x0001-0x0100")]),v._v(" "),_("td",[v._v("16位無符號大端整數，表示容器區塊的數量")])]),v._v(" "),_("tr",[_("td",[v._v("容器區塊大小")]),v._v(" "),_("td",[v._v("4 位元組")]),v._v(" "),_("td",[v._v("0x00000001-0xFFFFFFFF")]),v._v(" "),_("td",[v._v("32位無符號大端整數，表示容器區塊內容的長度")])]),v._v(" "),_("tr",[_("td",[v._v("資料區塊標記")]),v._v(" "),_("td",[v._v("1 位元組")]),v._v(" "),_("td",[v._v("0xFF")]),v._v(" "),_("td",[v._v("資料區塊大小區塊的標記")])]),v._v(" "),_("tr",[_("td",[v._v("資料區塊大小")]),v._v(" "),_("td",[v._v("2 位元組")]),v._v(" "),_("td",[v._v("0x0000-0xFFFF")]),v._v(" "),_("td",[v._v("16位無符號大端整數，表示資料區塊內容的長度 (*)")])]),v._v(" "),_("tr",[_("td",[v._v("終止符號")]),v._v(" "),_("td",[v._v("1 位元組")]),v._v(" "),_("td",[v._v("0x00")]),v._v(" "),_("td",[v._v("標記標頭的結束")])])])]),v._v(" "),_("p",[v._v("(*) 對於尚未部署的容器，這可能大於實際內容長度，我們在部署的章節會特別討論。")]),v._v(" "),_("h4",{attrs:{id:"主體"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#主體"}},[v._v("#")]),v._v(" 主體")]),v._v(" "),_("table",[_("thead",[_("tr",[_("th",[v._v("名稱")]),v._v(" "),_("th",[v._v("長度")]),v._v(" "),_("th",[v._v("值")]),v._v(" "),_("th",[v._v("說明")])])]),v._v(" "),_("tbody",[_("tr",[_("td",[v._v("類型區塊")]),v._v(" "),_("td",[v._v("可變")]),v._v(" "),_("td",[v._v("n/a")]),v._v(" "),_("td",[v._v("存儲程式區塊詮釋資料")])]),v._v(" "),_("tr",[_("td",[v._v("輸入")]),v._v(" "),_("td",[v._v("1 位元組")]),v._v(" "),_("td",[v._v("0x00-0x7F")]),v._v(" "),_("td",[v._v("程式區塊消耗的堆疊元素數量")])]),v._v(" "),_("tr",[_("td",[v._v("輸出")]),v._v(" "),_("td",[v._v("1 位元組")]),v._v(" "),_("td",[v._v("0x00-0x7F")]),v._v(" "),_("td",[v._v("程式區塊回傳的堆疊元素數量")])]),v._v(" "),_("tr",[_("td",[v._v("最大堆疊增加")]),v._v(" "),_("td",[v._v("2 位元組")]),v._v(" "),_("td",[v._v("0x0000-0x03FF")]),v._v(" "),_("td",[v._v("程式執行期間堆疊可能增加的最大高度")])]),v._v(" "),_("tr",[_("td",[v._v("程式區塊")]),v._v(" "),_("td",[v._v("可變")]),v._v(" "),_("td",[v._v("n/a")]),v._v(" "),_("td",[v._v("任意位元碼")])]),v._v(" "),_("tr",[_("td",[v._v("容器區塊")]),v._v(" "),_("td",[v._v("可變")]),v._v(" "),_("td",[v._v("n/a")]),v._v(" "),_("td",[v._v("任意 EOF 格式的容器")])]),v._v(" "),_("tr",[_("td",[v._v("資料區塊")]),v._v(" "),_("td",[v._v("可變")]),v._v(" "),_("td",[v._v("n/a")]),v._v(" "),_("td",[v._v("任意位元組序列")])])])]),v._v(" "),_("p",[_("strong",[v._v("注意")]),v._v("："),_("code",[v._v("輸出")]),v._v(" 的特殊值 "),_("code",[v._v("0x80")]),v._v(" 被指定用於表示不回傳的函數，在單獨的 EIP 中定義。")]),v._v(" "),_("h4",{attrs:{id:"eof-第一版驗證規則"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#eof-第一版驗證規則"}},[v._v("#")]),v._v(" EOF 第一版驗證規則")]),v._v(" "),_("p",[v._v("對容器格式有以下有效性約束：")]),v._v(" "),_("ul",[_("li",[_("code",[v._v("類型區塊大小")]),v._v(" 可被 "),_("code",[v._v("4")]),v._v(" 整除")]),v._v(" "),_("li",[v._v("程式區塊的數量必須等於 "),_("code",[v._v("類型區塊大小 / 4")])]),v._v(" "),_("li",[v._v("對於尚未部署的容器，資料主體長度可能短於 "),_("code",[v._v("資料區塊大小")])]),v._v(" "),_("li",[v._v("容器的總大小不得超過 "),_("code",[v._v("MAX_INITCODE_SIZE")]),v._v("（如 "),_("RouterLink",{attrs:{to:"/head-first-eof/eip-3860.html"}},[v._v("EIP-3860")]),v._v(" 中定義）")],1)]),v._v(" "),_("h3",{attrs:{id:"執行語意的更改"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#執行語意的更改"}},[v._v("#")]),v._v(" 執行語意的更改")]),v._v(" "),_("p",[v._v("對於 EOF 合約：")]),v._v(" "),_("ul",[_("li",[v._v("執行從程式區塊 0 的第一個位元組開始")]),v._v(" "),_("li",[_("code",[v._v("CODESIZE")]),v._v("、"),_("code",[v._v("CODECOPY")]),v._v("、"),_("code",[v._v("EXTCODESIZE")]),v._v("、"),_("code",[v._v("EXTCODECOPY")]),v._v("、"),_("code",[v._v("EXTCODEHASH")]),v._v("、"),_("code",[v._v("GAS")]),v._v(" 在 EOF 合約中被禁止，且將無後續的對應替代指令，驗證階段將被拒絕")]),v._v(" "),_("li",[_("code",[v._v("CALL")]),v._v("、"),_("code",[v._v("DELEGATECALL")]),v._v("、"),_("code",[v._v("STATICCALL")]),v._v(" 在 EOF 合約中也被禁止使用，其相關的替代指令將在單獨的 EIP 中另外定義。")]),v._v(" "),_("li",[v._v("從 EOF 合約到非 EOF 合約（傳統合約、EOA、空帳戶）的 "),_("code",[v._v("DELEGATECALL")]),v._v("（或任何 EOF 的替代指令）是不允許的，如被觸發，將以呼叫深度檢查失敗的相同模式觸發錯誤。反之，允許從傳統合約到 EOF 合約的 "),_("code",[v._v("DELEGATECALL")]),v._v("，這樣能使現存的代理合約能夠使用 EOF 升級。")])]),v._v(" "),_("p",[v._v("對於傳統合約：")]),v._v(" "),_("ul",[_("li",[v._v("如果 "),_("code",[v._v("EXTCODECOPY")]),v._v(" 的目標帳戶是 EOF 合約，那麼它將複製最多 2 個位元組的 "),_("code",[v._v("EF00")]),v._v("。")]),v._v(" "),_("li",[v._v("如果 "),_("code",[v._v("EXTCODEHASH")]),v._v(" 的目標帳戶是 EOF 合約，那麼它將回傳 "),_("code",[v._v("0x9dbf3648db8210552e9c4f75c6a1c3057c0ca432043bd648be15fe7be05646f5")]),v._v("（"),_("code",[v._v("EF00")]),v._v(" 的雜湊值）。")]),v._v(" "),_("li",[v._v("如果 "),_("code",[v._v("EXTCODESIZE")]),v._v(" 的目標帳戶是 EOF 合約，那麼它將回傳 2。")])]),v._v(" "),_("p",[_("strong",[v._v("注意")]),v._v(" 與傳統合約一樣，上述 "),_("code",[v._v("EXTCODECOPY")]),v._v("、"),_("code",[v._v("EXTCODEHASH")]),v._v(" 和 "),_("code",[v._v("EXTCODESIZE")]),v._v(" 的行為不適用於正在部署中的 EOF 合約目標。")]),v._v(" "),_("h2",{attrs:{id:"設計原因"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#設計原因"}},[v._v("#")]),v._v(" 設計原因")]),v._v(" "),_("ol",[_("li",[v._v("魔法標記的第一個位元組 "),_("code",[v._v("0xEF")]),v._v(" 是特別保留的")]),v._v(" "),_("li",[v._v("第二個位元組 "),_("code",[v._v("0x00")]),v._v(" 是為了避免與現有的程式衝突")]),v._v(" "),_("li",[v._v("版本號從 1 開始，這樣我們可以把舊的程式稱為「版本0」")]),v._v(" "),_("li",[v._v("把資料區塊放在最後，因為這是在部署程式時最可能會添加內容的部分，比如有部分的資料需要在初始化階段才能計算出來")])])])}),[],!1,null,null,null);_.default=e.exports}}]);